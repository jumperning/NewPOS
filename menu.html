<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Men√∫ ‚Äî OnceyDoce</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body class="bg-slate-100 min-h-screen p-6">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-2xl font-bold mb-4">Gestor de Men√∫ OnceyDoce üçî</h1>

    <!-- Filtros -->
    <div class="flex flex-wrap gap-3 mb-6 bg-white p-4 rounded-xl shadow">
      <input id="q" class="border rounded px-3 py-2 flex-1" placeholder="Buscar por nombre, SKU o categor√≠a...">
      <select id="cat" class="border rounded px-3 py-2">
        <option value="">Todas las categor√≠as</option>
      </select>
      <button id="refresh" class="bg-slate-800 text-white px-4 py-2 rounded">Refrescar</button>
    </div>

    <!-- Contenedor de tarjetas -->
    <div id="menuList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
  </div>

<script>
const ORDERS_WEBAPP_URL = '/.netlify/functions/gs-order';

// =============== API HELPERS ===============
async function apiGet(qs){
  const url = new URL(ORDERS_WEBAPP_URL, location.origin);
  Object.entries(qs).forEach(([k,v])=> url.searchParams.set(k,v));
  const r = await fetch(url);
  return r.json();
}
async function apiPost(body){
  const params = new URLSearchParams(body);
  const r = await fetch(ORDERS_WEBAPP_URL, {
    method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body: params
  });
  return r.json();
}

// =============== RENDER ===============
function productCard(p){
  const desact = String(p.stock).toLowerCase()==='no';
  const checked = String(p.masvendido).toLowerCase()==='si' ? 'checked' : '';
  const stockVal = desact ? 'no' : (p.stock==='' ? '' : Number(p.stock));

  return `
  <div data-row="${p._row}" class="bg-white rounded-xl shadow p-4 flex flex-col gap-3 ${desact?'opacity-60':''}">
    <div class="flex items-start gap-3">
      <img src="${p.img || 'https://via.placeholder.com/80x80?text=Sin+imagen'}"
           onerror="this.src='https://via.placeholder.com/80x80?text=Error'"
           class="h-20 w-20 object-cover rounded border"/>

      <div class="flex-1">
        <input data-k="nombre" class="w-full font-semibold text-lg outline-none" value="${p.nombre||''}">
        <div class="text-sm text-slate-500">${p.sku || ''}</div>
      </div>
    </div>

    <div class="grid grid-cols-2 gap-2 text-sm">
      <input data-k="categoria" class="inp" placeholder="Categor√≠a" value="${p.categoria||''}">
      <input data-k="subcategoria" class="inp" placeholder="Subcategor√≠a" value="${p.subcategoria||''}">
      <input data-k="TIPO" class="inp" placeholder="Tipo" value="${p.TIPO||''}">
      <input data-k="SUBTIPO" class="inp" placeholder="Subtipo" value="${p.SUBTIPO||''}">
    </div>

    <div class="flex flex-col">
      <label class="text-xs text-slate-500">Imagen (URL)</label>
      <input data-k="img" class="inp" placeholder="https://..." value="${p.img||''}">
    </div>

    <div class="flex justify-between items-center text-sm">
      <div class="flex flex-col">
        <label class="text-xs text-slate-500">Precio</label>
        <input data-k="precio" type="number" class="inp w-24 text-right" value="${Number(p.precio)||0}">
      </div>
      <div class="flex flex-col">
        <label class="text-xs text-slate-500">Costo</label>
        <input data-k="Costo" type="number" class="inp w-24 text-right" value="${Number(p.Costo)||0}">
      </div>
      <div class="flex flex-col">
        <label class="text-xs text-slate-500">Stock</label>
        <input data-k="stock" class="inp w-20 text-center" value="${stockVal}">
      </div>
      <div class="flex items-center gap-1">
        <input type="checkbox" data-k="masvendido" ${checked}>
        <label class="text-xs">M√°s vendido</label>
      </div>
    </div>

    <div class="flex gap-2 justify-end mt-2">
      <button class="bg-rose-600 text-white px-3 py-1 rounded" data-action="del">Borrar</button>
      <button class="bg-slate-700 text-white px-3 py-1 rounded" data-action="save">Guardar</button>
    </div>
  </div>`;
}

function renderMenu(list){
  const $list = $('#menuList');
  $list.empty();
  const q = ($('#q').val()||'').toLowerCase();
  const cat = $('#cat').val()||'';
  list
    .filter(p => !cat || p.categoria===cat)
    .filter(p => !q || [p.nombre,p.categoria,p.subcategoria,p.sku].join(' ').toLowerCase().includes(q))
    .forEach(p => $list.append(productCard(p)));
}

// =============== CRUD ===============
function readCard($card){
  const get = k => $card.find(`[data-k="${k}"]`);
  return {
    _row: Number($card.data('row')||0),
    sku: '',
    nombre: get('nombre').val(),
    categoria: get('categoria').val(),
    subcategoria: get('subcategoria').val(),
    TIPO: get('TIPO').val(),
    SUBTIPO: get('SUBTIPO').val(),
    img: get('img').val(),
    precio: Number(get('precio').val()||0),
    Costo: Number(get('Costo').val()||0),
    stock: (() => {
      const v = String(get('stock').val()||'').trim();
      if (v.toLowerCase()==='no') return 'no';
      const n = Number(v); return isNaN(n)?'':n;
    })(),
    masvendido: $card.find('[data-k="masvendido"]').prop('checked') ? 'si' : 'no'
  };
}

$('#menuList').on('click','[data-action="save"]', async function(){
  const $c = $(this).closest('[data-row]');
  const payload = readCard($c);
  const res = await apiPost({action:'menu_upsert', payload: JSON.stringify(payload)});
  if(!res.ok && !res.created && !res.updated) alert(res.error||'Error al guardar');
  else await refreshMenu();
});

$('#menuList').on('click','[data-action="del"]', async function(){
  const $c = $(this).closest('[data-row]');
  const row = Number($c.data('row')||0);
  if(!row || !confirm('¬øBorrar este producto?')) return;
  const res = await apiPost({action:'menu_delete', payload: JSON.stringify({_row:row})});
  if(!res.ok && !res.deleted) alert(res.error||'Error al borrar');
  else $c.remove();
});

// =============== LOAD ===============
async function refreshMenu(){
  const res = await apiGet({action:'menu_list'});
  if(!res.ok){ alert(res.error||'Error al cargar'); return; }
  window.__MENU = res.items || [];
  const cats = [...new Set(window.__MENU.map(x=>x.categoria).filter(Boolean))];
  $('#cat').empty().append('<option value="">Todas</option>');
  cats.forEach(c=> $('#cat').append(`<option>${c}</option>`));
  renderMenu(window.__MENU);
}

$('#refresh').on('click', refreshMenu);
$('#q').on('input', ()=> renderMenu(window.__MENU||[]));
$('#cat').on('change', ()=> renderMenu(window.__MENU||[]));

$(refreshMenu);
</script>

<style>
  .inp{ @apply border rounded px-2 py-1 bg-slate-50 focus:bg-white focus:border-slate-400; }
</style>
</body>
</html>
