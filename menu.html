<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Editor de Productos — OnceyDoce</title>

  <script> window.tailwind = { config: { darkMode: 'class' } } </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{ --surface:#ffffff; --accent-600:#e11d48; }
    .card{ background:#fff; border:1px solid #e5e7eb; border-radius:1rem; }
    .btn{ padding:.5rem .875rem; border-radius:.75rem; border:1px solid #e5e7eb; background:#fff; }
    .btn:hover{ background:#f9fafb }
    .btn-primary{ border:none; background:var(--accent-600); color:#fff }
    .btn-primary:hover{ filter:brightness(1.05) }
    .inp{ border-radius:.6rem; border:1px solid #e5e7eb; padding:.45rem .6rem; }
    .inp:focus{ outline:none; box-shadow:0 0 0 3px rgba(225,29,72,.15); border-color:var(--accent-600) }
    .pill{font-size:.7rem;padding:.15rem .5rem;border-radius:999px;border:1px solid #e5e7eb}
    td,th{ padding:.5rem .6rem; border-bottom:1px solid #eef2f7; vertical-align:middle; }
    table{ width:100%; border-collapse:separate; border-spacing:0; }
  </style>

  <script>
    // Reusamos las mismas claves que tu POS:
    window.ODPOS = window.ODPOS || {};
    window.ODPOS.ORDERS_WEBAPP_URL = window.ODPOS.ORDERS_WEBAPP_URL || "/.netlify/functions/gs-order";
  </script>
</head>
<body class="bg-slate-50 text-black">
  <!-- LOGIN OVERLAY -->
  <div id="loginOverlay" class="fixed inset-0 bg-white/90 backdrop-blur-sm grid place-items-center z-[100]">
    <div class="w-[min(420px,92vw)] card p-6">
      <h2 class="text-xl font-bold mb-4">Ingresar (solo Admin)</h2>
      <div class="space-y-3">
        <div>
          <label class="block text-sm mb-1">Usuario</label>
          <input id="loginUser" class="inp w-full" placeholder="Admin"/>
        </div>
        <div>
          <label class="block text-sm mb-1">Clave</label>
          <input id="loginPass" type="password" class="inp w-full" placeholder="••••••"/>
        </div>
        <button id="btnLogin" class="btn-primary w-full rounded-xl py-2 font-semibold">Entrar</button>
        <div id="loginMsg" class="text-sm text-red-600 hidden"></div>
      </div>
      <p class="text-xs text-gray-500 mt-4">Solo <b>Admin</b> puede editar el menú.</p>
    </div>
  </div>

  <header class="sticky top-0 z-40 bg-white border-b border-slate-200">
    <div class="px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-8 w-8 grid place-items-center rounded-lg bg-[var(--accent-600)] text-white font-black">OD</div>
        <div class="font-bold">Editor de Productos</div>
        <span id="status" class="pill ml-2">Listo</span>
      </div>
      <div id="userBadge" class="text-xs text-gray-500"></div>
    </div>
  </header>

  <main class="p-4 sm:p-6 max-w-7xl mx-auto space-y-6">
    <div class="card p-4">
      <div class="grid sm:grid-cols-3 gap-3">
        <div>
          <label class="block text-sm mb-1">Buscar</label>
          <input id="buscar" class="inp w-full" placeholder="nombre, sku, categoría…"/>
        </div>
        <div>
          <label class="block text-sm mb-1">Categoría</label>
          <input id="filCat" class="inp w-full" placeholder="Filtrar por categoría"/>
        </div>
        <div class="flex items-end">
          <button id="btnRefrescar" class="btn rounded-xl">Refrescar</button>
        </div>
      </div>
    </div>

    <div class="card p-0 overflow-auto">
      <table id="tbl">
        <thead class="bg-slate-50 text-slate-700 text-sm">
          <tr>
            <th>SKU</th>
            <th>Nombre</th>
            <th>Categoría</th>
            <th>Subcat</th>
            <th class="text-right">Precio</th>
            <th class="text-right">Costo</th>
            <th class="text-right">Stock</th>
            <th class="text-right">Min</th>
            <th style="width:160px"></th>
          </tr>
        </thead>
        <tbody id="tbody" class="text-sm"></tbody>
      </table>
    </div>

    <div class="card p-4">
      <h3 class="font-semibold mb-3">Nuevo producto</h3>
      <div class="grid md:grid-cols-8 gap-2">
        <input id="n_sku"  class="inp" placeholder="SKU">
        <input id="n_nombre" class="inp md:col-span-2" placeholder="Nombre">
        <input id="n_cat" class="inp" placeholder="Categoría">
        <input id="n_sub" class="inp" placeholder="Subcat">
        <input id="n_precio" class="inp" placeholder="Precio" type="number" step="1" min="0">
        <input id="n_costo" class="inp" placeholder="Costo" type="number" step="1" min="0">
        <input id="n_stock" class="inp" placeholder="Stock" type="number" step="1" min="0">
        <input id="n_min" class="inp" placeholder="Min" type="number" step="1" min="0">
      </div>
      <div class="mt-3 flex gap-2">
        <button id="btnCrear" class="btn-primary rounded-xl px-4 py-2">Crear</button>
        <span class="text-xs text-gray-500">* Valores numéricos sin puntos ni comas.</span>
      </div>
    </div>
  </main>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script>
  (() => {
    'use strict';

    const ORDERS_WEBAPP_URL = window.ODPOS.ORDERS_WEBAPP_URL;
    let CURRENT_USER = null; // {username, role, token}
    let DATA = []; // menú completo
    let FILTER = { q:'', cat:'' };

    // ===== API =====
    async function apiPost(params){
      const body = new URLSearchParams(params);
      if(CURRENT_USER?.token) body.set('token', CURRENT_USER.token);
      const r = await fetch(ORDERS_WEBAPP_URL, {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
        body
      });
      const t = await r.text();
      try{ return JSON.parse(t); }catch{ return {ok:r.ok} }
    }
    async function apiGet(params){
      const qs = new URLSearchParams(params);
      if(CURRENT_USER?.token) qs.set('token', CURRENT_USER.token);
      const r = await fetch(`${ORDERS_WEBAPP_URL}?${qs.toString()}`);
      return r.json();
    }

    async function login(u,p){
      const res = await apiPost({ action:'login', payload: JSON.stringify({ username:u, password:p }) });
      if(!res.ok) throw new Error(res.error||'Login inválido');
      CURRENT_USER = { username:res.username, role:res.role, token:res.token };
      if (CURRENT_USER.role !== 'admin') throw new Error('Solo Admin puede editar el menú');
      $('#loginOverlay').addClass('hidden');
      $('#userBadge').text(`${CURRENT_USER.username} · ${CURRENT_USER.role}`);
    }

    // ===== UI =====
    function setStatus(msg){ $('#status').text(msg); }

    function matchesRow(r){
      const q = FILTER.q.toLowerCase();
      const inCat = !FILTER.cat || r.categoria.toLowerCase().includes(FILTER.cat.toLowerCase());
      const inText = !q || (r.nombre+' '+r.sku+' '+r.categoria+' '+r.subcategoria).toLowerCase().includes(q);
      return inCat && inText;
    }

    function rowHtml(r){
      // campos editables
      return `
        <tr data-row="${r._row}">
          <td><input class="inp w-32" data-k="sku" value="${escapeHtml(r.sku)}"></td>
          <td><input class="inp w-56" data-k="nombre" value="${escapeHtml(r.nombre)}"></td>
          <td><input class="inp w-40" data-k="categoria" value="${escapeHtml(r.categoria)}"></td>
          <td><input class="inp w-40" data-k="subcategoria" value="${escapeHtml(r.subcategoria)}"></td>
          <td class="text-right"><input class="inp w-24 text-right" data-k="precio" type="number" step="1" min="0" value="${Number(r.precio)||0}"></td>
          <td class="text-right"><input class="inp w-24 text-right" data-k="costo"  type="number" step="1" min="0" value="${Number(r.costo)||0}"></td>
          <td class="text-right"><input class="inp w-20 text-right" data-k="stock"  type="number" step="1" min="0" value="${r.stock===''?'':Number(r.stock)||0}"></td>
          <td class="text-right"><input class="inp w-20 text-right" data-k="min"    type="number" step="1" min="0" value="${r.min===''?'':Number(r.min)||0}"></td>
          <td class="text-right">
            <button class="btn-primary rounded-lg px-3 py-1.5" data-act="save">Guardar</button>
            <button class="btn rounded-lg px-3 py-1.5" data-act="del">Borrar</button>
          </td>
        </tr>`;
    }

    function render(){
      const tbody = $('#tbody'); tbody.empty();
      const rows = DATA.filter(matchesRow);
      if(!rows.length){
        tbody.html(`<tr><td colspan="9" class="text-center text-sm text-gray-500 py-6">Sin resultados</td></tr>`);
        return;
      }
      rows.forEach(r => tbody.append(rowHtml(r)));
    }

    function escapeHtml(s){
      return String(s||'').replace(/[<>&"]/g, m => ({'<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;'}[m]));
    }

    // ===== Data =====
    async function loadMenu(){
      setStatus('Cargando…');
      const res = await apiGet({ action:'menu_list' });
      if(!res.ok) throw new Error(res.error||'No se pudo listar');
      DATA = res.items || [];
      setStatus(`Productos: ${DATA.length}`);
      render();
    }

    async function upsertRow(domTr){
      const $_ = $(domTr);
      const _row = Number($_.data('row')||0);
      const payload = {
        _row,
        sku: $_.find('[data-k="sku"]').val().trim(),
        nombre: $_.find('[data-k="nombre"]').val().trim(),
        categoria: $_.find('[data-k="categoria"]').val().trim(),
        subcategoria: $_.find('[data-k="subcategoria"]').val().trim(),
        precio: Number($_.find('[data-k="precio"]').val()||0),
        costo:  Number($_.find('[data-k="costo"]').val()||0),
        stock:  $_.find('[data-k="stock"]').val()==='' ? '' : Number($_.find('[data-k="stock"]').val()||0),
        min:    $_.find('[data-k="min"]').val()===''   ? '' : Number($_.find('[data-k="min"]').val()||0),
      };

      // validaciones mínimas
      if (!payload.nombre) { alert('Nombre es requerido'); return; }
      if (payload.precio < 0 || payload.costo < 0) { alert('Precio/Costo inválidos'); return; }

      setStatus('Guardando…');
      const res = await apiPost({ action:'menu_upsert', payload: JSON.stringify(payload) });
      if(!res.ok) { setStatus('Error'); alert(res.error||'No se pudo guardar'); return; }

      // refrescamos en memoria
      await loadMenu();
      setStatus('Guardado ✅');
    }

    async function deleteRow(domTr){
      const _row = Number($(domTr).data('row')||0);
      if(!_row) return;
      if(!confirm('¿Borrar este producto?')) return;
      setStatus('Borrando…');
      const res = await apiPost({ action:'menu_delete', payload: JSON.stringify({_row}) });
      if(!res.ok){ setStatus('Error'); alert(res.error||'No se pudo borrar'); return; }
      await loadMenu();
      setStatus('Borrado ✅');
    }

    async function createNew(){
      const payload = {
        sku: $('#n_sku').val().trim(),
        nombre: $('#n_nombre').val().trim(),
        categoria: $('#n_cat').val().trim(),
        subcategoria: $('#n_sub').val().trim(),
        precio: Number($('#n_precio').val()||0),
        costo:  Number($('#n_costo').val()||0),
        stock:  $('#n_stock').val()==='' ? '' : Number($('#n_stock').val()||0),
        min:    $('#n_min').val()===''   ? '' : Number($('#n_min').val()||0),
      };
      if(!payload.nombre){ alert('Nombre es requerido'); return; }
      setStatus('Creando…');
      const res = await apiPost({ action:'menu_upsert', payload: JSON.stringify(payload) });
      if(!res.ok){ setStatus('Error'); alert(res.error||'No se pudo crear'); return; }
      // limpiar form
      $('#n_sku,#n_nombre,#n_cat,#n_sub,#n_precio,#n_costo,#n_stock,#n_min').val('');
      await loadMenu();
      setStatus('Creado ✅');
    }

    // ===== Eventos =====
    function bind(){
      $('#btnLogin').on('click', async()=>{
        try{
          const u = $('#loginUser').val().trim();
          const p = $('#loginPass').val();
          await login(u,p);
          await loadMenu();
        }catch(e){
          $('#loginMsg').removeClass('hidden').text(e.message||'Error');
        }
      });

      $('#buscar').on('input', function(){ FILTER.q = $(this).val(); render(); });
      $('#filCat').on('input', function(){ FILTER.cat = $(this).val(); render(); });
      $('#btnRefrescar').on('click', loadMenu);

      $('#tbody').on('click','button[data-act="save"]', function(){
        upsertRow($(this).closest('tr')[0]);
      });
      $('#tbody').on('click','button[data-act="del"]', function(){
        deleteRow($(this).closest('tr')[0]);
      });

      $('#btnCrear').on('click', createNew);
    }

    $(function(){ bind(); });
  })();
  </script>
</body>
</html>
