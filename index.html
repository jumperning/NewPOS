<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>POS OnceyDoce — Multi‑Carritos + Google Sheets</title>
  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <!-- PapaParse for CSV parsing (from Google Sheets published CSV) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    @media print { .no-print { display:none!important } .print\:block{display:block!important} }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="max-w-7xl mx-auto p-4 sm:p-6 grid grid-cols-1 lg:grid-cols-12 gap-4">
    <!-- SIDEBAR: Carritos/Mesas -->
    <aside class="lg:col-span-3 bg-white rounded-2xl shadow p-4 h-fit sticky top-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Mesas / Carritos</h2>
        <button id="btnNuevaMesa" class="px-3 py-1.5 rounded-xl text-sm bg-emerald-600 text-white hover:bg-emerald-700">+ Nueva</button>
      </div>

      <div id="listaMesas" class="space-y-2"></div>

      <div class="mt-4 p-3 rounded-xl bg-gray-50">
        <label class="block text-xs text-gray-500 mb-1">Color de la mesa seleccionada</label>
        <input id="colorMesa" type="color" class="w-full h-10 rounded cursor-pointer" />
      </div>

      <p class="text-xs text-gray-500 mt-4">Consejo: duplicá una mesa para armar pedidos similares y acelerar la carga.</p>
    </aside>

    <!-- MAIN -->
    <main class="lg:col-span-9">
      <header class="mb-4">
        <div class="rounded-2xl bg-white shadow p-6 flex items-center justify-between">
          <div>
            <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">POS OnceyDoce</h1>
            <p class="text-sm text-gray-500">Multi‑carritos · Google Sheets</p>
          </div>
          <div class="text-right">
            <div id="statusBadge" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">Sincronizando…</div>
          </div>
        </div>
      </header>
      <!-- CONFIG PLACEHOLDERS -->
    <script>
      // === CONFIGURACIÓN ===
      // 1) Publica tu hoja de MENÚ como CSV (Archivo → Compartir → Publicar en la web → seleccionar la hoja del menú) y pega la URL aquí.
          //    También funciona con la URL de gviz CSV: https://docs.google.com/spreadsheets/d/ID/gviz/tq?tqx=out:csv&sheet=NombreHoja
      const MENU_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTOCWWvu8KMMGhuRlTtbvCMEaJIWb9l3DYMi7281gfgncS5tGeO81BRpcCMk-SJIWtNyvWckt2bV4U-/pub?output=csv";

      // 2) Implementa el WebApp de Apps Script (ver instrucciones) que recibe los pedidos con método POST y pega la URL aquí.
      const ORDERS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzDOjveLDLPJI344Z9nm4DGfjytidwisPt3hU01lFzDK6siuI9GhFzhPxrdw-t2JD8u/exec";

      // 3) Opcional: nombre del local para imprimir comanda
      const STORE_NAME = "OnceyDoce";
    </script>


     <!-- Filters & Customer -->
<section class="mb-6 grid grid-cols-1 lg:grid-cols-3 gap-4">
  <!-- Toggle de modo -->
  <div class="rounded-2xl bg-white shadow p-4 lg:col-span-3">
    <div class="flex items-center gap-3">
      <span class="text-sm text-gray-600">Modo de filtros:</span>
      <div class="inline-flex rounded-xl overflow-hidden border">
        <button id="modoBotones" class="px-3 py-1.5 text-sm font-medium bg-emerald-600 text-white">Botones</button>
        <button id="modoDesplegable" class="px-3 py-1.5 text-sm font-medium bg-white text-gray-700">Desplegables</button>
      </div>
    </div>
  </div>

  <!-- Modo DESPLEGABLES (como ya tenías) -->
  <div id="filtrosDesplegables" class="grid grid-cols-1 lg:grid-cols-3 gap-4 lg:col-span-3">
    <div class="rounded-2xl bg-white shadow p-4">
      <label class="block text-sm font-medium mb-1" for="categoria">Categoría</label>
      <select id="categoria" class="w-full rounded-xl border-gray-300 focus:ring-2 focus:ring-emerald-500">
        <option value="">Todas</option>
      </select>
    </div>
    <div class="rounded-2xl bg-white shadow p-4">
      <label class="block text-sm font-medium mb-1" for="subcategoria">Subcategoría</label>
      <select id="subcategoria" class="w-full rounded-xl border-gray-300 focus:ring-2 focus:ring-emerald-500">
        <option value="">Todas</option>
      </select>
    </div>
    <div class="rounded-2xl bg-white shadow p-4">
      <label class="block text-sm font-medium mb-1" for="cliente">Nombre del cliente</label>
      <input id="cliente" type="text" placeholder="Ej: Juan Pérez" class="w-full rounded-xl border-gray-300 focus:ring-2 focus:ring-emerald-500" />
    </div>
  </div>

  <!-- Modo BOTONES -->
  <div id="filtrosBotones" class="lg:col-span-3 hidden">
    <!-- Categorías -->
    <div class="rounded-2xl bg-white shadow p-4 mb-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold">Elegí una categoría</h3>
        <button id="btnCatTodas" class="text-sm px-3 py-1.5 rounded-xl bg-gray-100 hover:bg-gray-200">Todas</button>
      </div>
      <div id="gridCategorias" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3"></div>
    </div>
    <!-- Subcategorías -->
    <div class="rounded-2xl bg-white shadow p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold">Subcategoría</h3>
        <button id="btnSubTodas" class="text-sm px-3 py-1.5 rounded-xl bg-gray-100 hover:bg-gray-200">Todas</button>
      </div>
      <div id="gridSubcategorias" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3"></div>
    </div>
  </div>
</section>


      <!-- Products & Cart -->
      <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Products -->
        <div class="rounded-2xl bg-white shadow overflow-hidden">
          <div class="p-4 border-b flex items-center gap-3">
            <input id="buscar" type="text" placeholder="Buscar producto…" class="flex-1 rounded-xl border-gray-300 focus:ring-2 focus:ring-emerald-500" />
            <span class="text-sm text-gray-500">Productos: <b id="countProductos">0</b></span>
          </div>
          <div class="divide-y max-h-[520px] overflow-auto" id="listaProductos"></div>
        </div>

        <!-- Cart -->
        <div id="cartWrapper" class="rounded-2xl bg-white shadow overflow-hidden border-2" style="border-color:#e5e7eb">
          <div class="p-4 border-b flex items-center justify-between">
            <h2 class="text-xl font-semibold"><span id="mesaTitulo">Mesa 1</span></h2>
            <div class="flex gap-2 items-center">
              <button id="btnDuplicarMesa" class="no-print px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-sm">Duplicar</button>
              <button id="btnVaciar" class="no-print px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-sm">Vaciar</button>
            </div>
          </div>
          <div class="p-4">
            <div id="cartTable" class="w-full text-sm"></div>
            <hr class="my-4" />
            <div class="grid grid-cols-2 gap-4 text-sm">
              <div class="space-y-2">
                <div class="flex items-center justify-between"><span>Total bruto</span><span id="totalBruto" class="font-semibold">$0</span></div>
                <div class="flex items-center justify-between"><span>Costo</span><span id="totalCosto" class="font-semibold">$0</span></div>
                <div class="flex items-center justify-between"><span>Ganancia</span><span id="totalGanancia" class="font-semibold">$0</span></div>
              </div>
              <div class="space-y-2">
                <label class="block text-sm" for="pago">Pago ($)</label>
                <input id="pago" type="number" min="0" class="w-full rounded-xl border-gray-300 focus:ring-2 focus:ring-emerald-500"/>
                <div class="flex items-center justify-between"><span>Vuelto</span><span id="vuelto" class="font-semibold">$0</span></div>
              </div>
            </div>
          </div>
          <div class="p-4 border-t flex flex-col sm:flex-row gap-3 sm:gap-4">
            <button id="btnGuardar" class="no-print flex-1 px-4 py-3 rounded-2xl bg-emerald-600 hover:bg-emerald-700 text-white font-semibold">Guardar Pedido</button>
            <button id="btnComanda" class="no-print flex-1 px-4 py-3 rounded-2xl bg-amber-500 hover:bg-amber-600 text-white font-semibold">Imprimir Comanda</button>
          </div>
        </div>
      </section>

      <!-- Printable ticket (hidden) -->
      <section id="ticket" class="hidden print:block p-6">
        <div class="max-w-sm mx-auto">
          <h2 class="text-center text-xl font-bold mb-2">{{STORE}}</h2>
          <div class="text-xs text-center mb-4" id="ticketMeta"></div>
          <div id="ticketItems" class="text-sm"></div>
          <hr class="my-2"/>
          <div class="text-sm">
            <div class="flex justify-between"><span>Total</span><span id="ticketTotal"></span></div>
            <div class="flex justify-between"><span>Pago</span><span id="ticketPago"></span></div>
            <div class="flex justify-between"><span>Vuelto</span><span id="ticketVuelto"></span></div>
          </div>
          <p class="text-center text-xs mt-4">¡Gracias por su compra!</p>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ===== Menú / productos =====
    let MENU = [];

    // ===== Multi‑Carritos =====
    // Estructura de mesa: { id, nombre, color, items:[], cliente:'', pago:0 }
    let MESAS = [];
    let MESA_ACTUAL = null; // id

    // ===== Utils =====
    const $fmt = (n) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', maximumFractionDigits: 0 }).format(Number(n||0));
    const uid = () => 'm' + Math.random().toString(36).slice(2,9);

    // --- Storage ---
    function loadState(){
      try{ const raw = localStorage.getItem('pos-1112-mesas'); if(raw){ const data = JSON.parse(raw); MESAS = data.mesas||[]; MESA_ACTUAL = data.actual||null; } }catch{ }
      if(MESAS.length===0){ const id = uid(); MESAS=[{id, nombre:'Mesa 1', color:'#22c55e', items:[], cliente:'', pago:0}]; MESA_ACTUAL=id; }
    }
    function saveState(){ localStorage.setItem('pos-1112-mesas', JSON.stringify({mesas:MESAS, actual:MESA_ACTUAL})); }

    function mesaActual(){ return MESAS.find(m=>m.id===MESA_ACTUAL); }

    // --- Sidebar render ---
    function renderMesas(){
      const cont = $('#listaMesas');
      cont.empty();
      MESAS.forEach(m=>{
        const active = m.id===MESA_ACTUAL;
        cont.append(`
          <div class="group flex items-center justify-between gap-2 p-2 rounded-xl border ${active?'border-emerald-500 bg-emerald-50':'border-gray-200 hover:bg-gray-50'}">
            <button class="flex items-center gap-2 flex-1 text-left" data-action="switch" data-id="${m.id}">
              <span class="inline-block w-3 h-3 rounded-full" style="background:${m.color}"></span>
              <span class="font-medium truncate">${m.nombre}</span>
              <span class="text-xs text-gray-500 ml-auto">${m.items.reduce((a,x)=>a+x.qty,0)} ítems</span>
            </button>
            <div class="opacity-0 group-hover:opacity-100 transition flex gap-1">
              <button class="px-2 py-1 text-xs rounded-lg bg-gray-100" title="Renombrar" data-action="rename" data-id="${m.id}">✎</button>
              <button class="px-2 py-1 text-xs rounded-lg bg-gray-100" title="Duplicar" data-action="dup" data-id="${m.id}">⧉</button>
              <button class="px-2 py-1 text-xs rounded-lg bg-gray-100" title="Eliminar" data-action="del" data-id="${m.id}">✕</button>
            </div>
          </div>`);
      });
      const m = mesaActual();
      $('#mesaTitulo').text(m.nombre);
      $('#cliente').val(m.cliente);
      $('#pago').val(m.pago);
      $('#colorMesa').val(m.color);
      $('#cartWrapper').css('border-color', m.color);
      renderCart();
      saveState();
    }

    function nuevaMesa(nombre='Mesa '+(MESAS.length+1), color='#22c55e'){
      const m = { id:uid(), nombre, color, items:[], cliente:'', pago:0 };
      MESAS.push(m); MESA_ACTUAL=m.id; renderMesas();
    }

    function duplicarMesa(id){
      const src = MESAS.find(m=>m.id===id); if(!src) return;
      const copy = { ...src, id:uid(), nombre: src.nombre+" (copia)", items: JSON.parse(JSON.stringify(src.items)) };
      MESAS.push(copy); MESA_ACTUAL=copy.id; renderMesas();
    }

    function eliminarMesa(id){
      if(MESAS.length===1){ alert('Debe quedar al menos una mesa.'); return; }
      MESAS = MESAS.filter(m=>m.id!==id);
      if(MESA_ACTUAL===id){ MESA_ACTUAL = MESAS[0].id; }
      renderMesas();
    }

    function cambiarColorActual(color){ const m=mesaActual(); if(!m) return; m.color=color; $('#cartWrapper').css('border-color', color); saveState(); renderMesas(); }

    // ===== Productos y filtros =====
    // ===== Filtros: modo botones vs desplegables =====
let FILTRO_MODO = 'botones'; // 'botones' | 'desplegables'
let CAT_SELECCIONADA = '';
let SUB_SELECCIONADA = '';

const categoriaIcon = (name='')=>{
  const n = name.toLowerCase();
  if(n.includes('hamb')) return '🍔';
  if(n.includes('sand') || n.includes('tost') || n.includes('sang')) return '🥪';
  if(n.includes('pizza')) return '🍕';
  if(n.includes('papa') || n.includes('frit')) return '🍟';
  if(n.includes('postre') || n.includes('dulce')) return '🍰';
  if(n.includes('bebida') || n.includes('gaseosa') || n.includes('agua')) return '🥤';
  if(n.includes('cerve') || n.includes('ipa') || n.includes('birra')) return '🍺';
  if(n.includes('trago') || n.includes('cocktail') || n.includes('coctel')) return '🍸';
  if(n.includes('cafe') || n.includes('espresso') || n.includes('latte')) return '☕️';
  if(n.includes('ensal')) return '🥗';
  return '🧾';
};

function pillButton(label, pressed=false){
  return `
    <button class="catpill ${pressed?'ring-2 ring-emerald-500':''} w-full text-left px-3 py-3 rounded-2xl bg-gray-50 hover:bg-gray-100 border border-gray-200"
      data-label="${label}">
      <div class="flex items-center gap-2">
        <span class="text-xl">${categoriaIcon(label)}</span>
        <span class="font-medium truncate">${label}</span>
      </div>
    </button>`;
}

// Redibuja combos (modo desplegables) con datos del menú
function renderFilters(){
  const cats = groupUnique(MENU, 'categoria');
  const catSel = $('#categoria');
  catSel.find('option:not(:first)').remove();
  cats.forEach(c => catSel.append(`<option value="${c}">${c}</option>`));
  renderSubcats();
}

// Subcats para desplegable
function renderSubcats(){
  const cat = $('#categoria').val();
  let list = MENU; if(cat) list = MENU.filter(x => x.categoria === cat);
  const subs = groupUnique(list, 'subcategoria');
  const subSel = $('#subcategoria');
  subSel.find('option:not(:first)').remove();
  subs.forEach(s => subSel.append(`<option value="${s}">${s}</option>`));
}

// Construye botones de categorías (modo botones)
function renderCategoryButtons(){
  const cats = groupUnique(MENU, 'categoria');
  const grid = $('#gridCategorias');
  grid.empty();
  cats.forEach(c=>{
    grid.append(pillButton(c, CAT_SELECCIONADA===c));
  });
}

// Construye botones de subcategorías en base a la categoría elegida
function renderSubcategoryButtons(){
  let list = MENU;
  if(CAT_SELECCIONADA) list = MENU.filter(x=>x.categoria===CAT_SELECCIONADA);
  const subs = groupUnique(list, 'subcategoria');
  const grid = $('#gridSubcategorias');
  grid.empty();
  subs.forEach(s=>{
    grid.append(pillButton(s, SUB_SELECCIONADA===s));
  });
}

// Cambia de modo visual
function setFiltroModo(modo){
  FILTRO_MODO = modo;
  if(modo==='botones'){
    $('#filtrosBotones').removeClass('hidden');
    $('#filtrosDesplegables').addClass('hidden');
    $('#modoBotones').removeClass('bg-white text-gray-700').addClass('bg-emerald-600 text-white');
    $('#modoDesplegable').removeClass('bg-emerald-600 text-white').addClass('bg-white text-gray-700');
    // Sincronizar estado actual de combos hacia botones
    CAT_SELECCIONADA = $('#categoria').val() || '';
    SUB_SELECCIONADA = $('#subcategoria').val() || '';
    renderCategoryButtons();
    renderSubcategoryButtons();
  }else{
    $('#filtrosDesplegables').removeClass('hidden');
    $('#filtrosBotones').addClass('hidden');
    $('#modoDesplegable').removeClass('bg-white text-gray-700').addClass('bg-emerald-600 text-white');
    $('#modoBotones').removeClass('bg-emerald-600 text-white').addClass('bg-white text-gray-700');
    // Sincronizar desde botones hacia combos
    $('#categoria').val(CAT_SELECCIONADA || '');
    renderSubcats();
    $('#subcategoria').val(SUB_SELECCIONADA || '');
  }
  renderProducts();
}

    function groupUnique(arr, key){ return [...new Set(arr.map(x => (x[key]||"").trim()).filter(Boolean))].sort((a,b)=>a.localeCompare(b)); }

    function renderFilters(){
      const cats = groupUnique(MENU, 'categoria');
      const catSel = $('#categoria');
      catSel.find('option:not(:first)').remove();
      cats.forEach(c => catSel.append(`<option value="${c}">${c}</option>`));
      renderSubcats();
    }
    function renderSubcats(){
      const cat = $('#categoria').val();
      let list = MENU; if(cat) list = MENU.filter(x => x.categoria === cat);
      const subs = groupUnique(list, 'subcategoria');
      const subSel = $('#subcategoria');
      subSel.find('option:not(:first)').remove();
      subs.forEach(s => subSel.append(`<option value="${s}">${s}</option>`));
    }

   function productMatches(p){
  const q = $('#buscar').val().trim().toLowerCase();

  // Si estoy en modo BOTONES uso el estado local, si no, leo de los <select>
  const cat = (FILTRO_MODO==='botones') ? (CAT_SELECCIONADA||'') : ($('#categoria').val()||'');
  const sub = (FILTRO_MODO==='botones') ? (SUB_SELECCIONADA||'') : ($('#subcategoria').val()||'');

  if(cat && p.categoria!==cat) return false;
  if(sub && p.subcategoria!==sub) return false;
  if(!q) return true;
  return [p.nombre,p.categoria,p.subcategoria].join(' ').toLowerCase().includes(q);
}


    function renderProducts(){
      const cont=$('#listaProductos'); cont.empty(); const list=MENU.filter(productMatches); $('#countProductos').text(list.length);
      list.forEach(p=>{
        const disp=(p.stock!==undefined && p.stock!==""?`<span class='text-xs text-gray-500'>Stock: ${p.stock}</span>`:"");
        cont.append(`
          <div class="p-3 flex items-center gap-3 hover:bg-gray-50">
            <div class="flex-1">
              <div class="font-medium">${p.nombre}</div>
              <div class="text-xs text-gray-500">${p.categoria}${p.subcategoria?" · "+p.subcategoria:""}</div>
              ${disp}
            </div>
            <div class="text-right">
              <div class="text-base font-semibold">${$fmt(p.precio)}</div>
              ${p.costo?`<div class="text-[11px] text-gray-500">Costo ${$fmt(p.costo)}</div>`:""}
            </div>
            <div>
              <button class="px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white text-sm" data-id="${p._rowId}" data-action="add">Agregar</button>
            </div>
          </div>`);
      });
    }

    // ===== Carrito (por mesa) =====
    function addToCart(rowId){ const m=mesaActual(); const p=MENU.find(x=>x._rowId===rowId); if(!m||!p) return; const ex=m.items.find(x=>x._rowId===rowId); if(ex){ex.qty+=1}else{m.items.push({_rowId:rowId,nombre:p.nombre,precio:Number(p.precio)||0,costo:Number(p.costo)||0,qty:1})} renderCart(); saveState(); }
    function removeFromCart(rowId){ const m=mesaActual(); if(!m) return; m.items = m.items.filter(x=>x._rowId!==rowId); renderCart(); saveState(); }
    function setQty(rowId,qty){ const m=mesaActual(); if(!m) return; const it=m.items.find(x=>x._rowId===rowId); if(it){ it.qty=Math.max(1,Number(qty)||1); renderCart(); saveState(); } }

    function renderCart(){
      const m=mesaActual(); const cont=$('#cartTable'); cont.empty(); if(!m){return}
      const CART=m.items;
      if(CART.length===0){ cont.html('<p class="text-sm text-gray-500">No hay ítems en el carrito.</p>'); }
      else{ CART.forEach(it=>{ const linea=it.precio*it.qty; cont.append(`
          <div class="grid grid-cols-12 gap-2 items-center py-2">
            <div class="col-span-5">
              <div class="font-medium">${it.nombre}</div>
              <div class="text-xs text-gray-500">${$fmt(it.precio)} c/u</div>
            </div>
            <div class="col-span-3">
              <input type="number" min="1" value="${it.qty}" data-id="${it._rowId}" data-action="qty" class="w-24 rounded-xl border-gray-300"/>
            </div>
            <div class="col-span-3 text-right font-semibold">${$fmt(linea)}</div>
            <div class="col-span-1 text-right">
              <button class="px-2 py-1 text-xs rounded-lg bg-gray-100 hover:bg-gray-200" data-id="${it._rowId}" data-action="del">✕</button>
            </div>
          </div>`); }); }

      const total = CART.reduce((a,x)=>a+x.precio*x.qty,0);
      const costo = CART.reduce((a,x)=>a+(Number(x.costo)||0)*x.qty,0);
      $('#totalBruto').text($fmt(total)); $('#totalCosto').text($fmt(costo)); $('#totalGanancia').text($fmt(total-costo));
      const pago = Number($('#pago').val()||m.pago||0); const vuelto = Math.max(0, pago-total); $('#vuelto').text($fmt(vuelto));
    }

    async function saveOrder(){
      const m=mesaActual(); if(!m) return;
      if(!ORDERS_WEBAPP_URL || ORDERS_WEBAPP_URL.startsWith('PASTE_')){ alert('Configura ORDERS_WEBAPP_URL'); return; }
      if(m.items.length===0){ alert('El carrito está vacío.'); return; }
      const total = m.items.reduce((a,x)=>a+x.precio*x.qty,0);
      const totalCosto = m.items.reduce((a,x)=>a+(Number(x.costo)||0)*x.qty,0);
      const payload = { timestamp:new Date().toISOString(), cliente:m.cliente||'', mesa:m.nombre, color:m.color, total, totalCosto, ganancia: total-totalCosto, pago: Number(m.pago||0), items: m.items.map(x=>({nombre:x.nombre,precio:x.precio,costo:x.costo,qty:x.qty})) };

      $('#btnGuardar').prop('disabled',true).text('Guardando…');
      try{
        const res = await fetch(ORDERS_WEBAPP_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}, body:'payload='+encodeURIComponent(JSON.stringify(payload)) });
        const txt = await res.text(); let data; try{ data=JSON.parse(txt) }catch{ data={ok:true} }
        if(!res.ok || data.ok===false) throw new Error((data && data.error) || 'Error al guardar');
        alert('Pedido guardado ✅');
        // limpiar mesa actual
        m.items=[]; renderCart(); saveState();
      }catch(err){ console.error(err); alert('No se pudo guardar el pedido: '+err.message); }
      finally{ $('#btnGuardar').prop('disabled',false).text('Guardar Pedido'); }
    }

    function printTicket(){
      const m=mesaActual(); if(!m) return;
      const meta = `${new Date().toLocaleString('es-AR')} · ${m.nombre} · Cliente: ${m.cliente||'-'}`;
      $('#ticketMeta').text(meta); $('#ticket').html($('#ticket').html().replace('{{STORE}}', STORE_NAME));
      const itemsHtml = m.items.map(x=>`<div class="flex justify-between"><span>${x.qty}× ${x.nombre}</span><span>${$fmt(x.qty*x.precio)}</span></div>`).join('');
      $('#ticketItems').html(itemsHtml);
      const total = m.items.reduce((a,x)=>a+x.precio*x.qty,0); const pago = Number(m.pago||0); const vuelto = Math.max(0, pago-total);
      $('#ticketTotal').text($fmt(total)); $('#ticketPago').text($fmt(pago)); $('#ticketVuelto').text($fmt(vuelto));
      window.print();
    }

    // ===== Eventos UI =====
    // Toggle de modo
$('#modoBotones').on('click', ()=> setFiltroModo('botones'));
$('#modoDesplegable').on('click', ()=> setFiltroModo('desplegables'));

// Botones "Todas"
$('#btnCatTodas').on('click', ()=>{
  CAT_SELECCIONADA=''; SUB_SELECCIONADA='';
  renderCategoryButtons(); renderSubcategoryButtons(); renderProducts();
});
$('#btnSubTodas').on('click', ()=>{
  SUB_SELECCIONADA=''; renderSubcategoryButtons(); renderProducts();
});

// Clicks en grid de categorías
$('#gridCategorias').on('click', '.catpill', function(){
  const label = $(this).data('label');
  CAT_SELECCIONADA = (CAT_SELECCIONADA===label ? '' : label);
  // Al cambiar categoría, reseteo subcategoría
  SUB_SELECCIONADA = '';
  renderCategoryButtons();
  renderSubcategoryButtons();
  renderProducts();
});

// Clicks en grid de subcategorías
$('#gridSubcategorias').on('click', '.catpill', function(){
  const label = $(this).data('label');
  SUB_SELECCIONADA = (SUB_SELECCIONADA===label ? '' : label);
  renderSubcategoryButtons();
  renderProducts();
});

// Mantener los eventos existentes de combos:
$('#categoria').on('change', function(){
  renderSubcats(); // para combos
  // Sincronizo el estado de botones por si se cambia en modo desplegable
  CAT_SELECCIONADA = $(this).val() || '';
  SUB_SELECCIONADA = '';
  renderProducts();
});
$('#subcategoria, #buscar').on('input change', function(){
  SUB_SELECCIONADA = (FILTRO_MODO==='botones') ? SUB_SELECCIONADA : ($('#subcategoria').val()||'');
  renderProducts();
});


    // ===== Carga de menú =====
    function normalizeRow(row, idx){
      return { _rowId:`r${idx}`, categoria:(row.categoria||row.Categoria||row.categoría||row.Categoría||'').toString().trim(), subcategoria:(row.subcategoria||row.Subcategoria||row.Subcategoría||row['Sub-categoria']||'').toString().trim(), nombre:(row.nombre||row.producto||row.Producto||row.Nombre||'').toString().trim(), precio:Number(row.precio||row.Precio||row.price||0), costo:Number(row.costo||row.Costo||row.cost||0), stock:(row.stock||row.Stock||'') };
    }

  async function loadMenu(){
  // buen estado visual del badge
  $('#statusBadge')
    .attr('class','inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700')
    .text('Cargando menú…');

  try{
    if (WEBAPP_URL) {
      // lee desde tu WebApp (GET ?action=menu)
      const res = await fetch(`${WEBAPP_URL}?action=menu`, {mode:'cors'});
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const { ok, rows, error } = await res.json();
      if (!ok) throw new Error(error || 'No se pudo leer menú');

      MENU = rows.map((r,idx)=>({
        _rowId: 'r'+idx,
        categoria: String(r.categoria||'').trim(),
        subcategoria: String(r.subcategoria||'').trim(),
        nombre: String(r.nombre||r.Producto||'').trim(),
        precio: Number(r.precio||0),
        costo: Number(r.costo||0),
        stock: r.stock==='' ? '' : Number(r.stock||0),
        min: Number(r.min||0),
        sku: r.sku || r.SKU || ''
      }));
    } else {
      // Fallback: leer CSV publicado (tu constante MENU_CSV_URL)
      await new Promise((resolve, reject)=>{
        Papa.parse(MENU_CSV_URL, {
          download:true, header:true,
          complete: (results)=>{
            MENU = (results.data||[])
              .filter(r=>r && Object.keys(r).length)
              .map((row, idx)=>({
                _rowId:'r'+idx,
                categoria:(row.categoria||row.Categoria||'').toString().trim(),
                subcategoria:(row.subcategoria||row.Subcategoria||'').toString().trim(),
                nombre:(row.nombre||row.producto||row.Producto||row.Nombre||'').toString().trim(),
                precio:Number(row.precio||row.Precio||0),
                costo:Number(row.costo||row.Costo||0),
                stock:(row.stock||row.Stock||''),
                min:Number(row.min||row.Min||0),
                sku: row.sku || row.SKU || ''
              }));
            resolve();
          },
          error: (err)=> reject(err)
        });
      });
    }

    renderFilters();
    renderProducts();
    renderCart();

    $('#statusBadge')
      .attr('class','inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700')
      .text('Menú sincronizado');
  }catch(err){
    console.error(err);
    $('#statusBadge')
      .attr('class','inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-700')
      .text('Error al cargar menú');
    alert('No se pudo cargar el menú: ' + err.message);
  }
}

    // ===== Init =====
    $(async function(){ loadState(); bindEvents(); renderMesas(); await loadMenu(); setFiltroModo('botones');  });
  </script>
</body>
</html>
