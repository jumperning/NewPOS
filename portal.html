<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reporte de Ventas — OnceyDoce</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    /* Reemplazo de @apply por CSS estándar */
    .chip{
      display:inline-flex; align-items:center;
      padding:0.125rem 0.5rem; border-radius:9999px;
      font-size:0.75rem; line-height:1rem;
      background:#f3f4f6; color:#374151;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="max-w-7xl mx-auto p-4 sm:p-6 space-y-6">
    <header class="rounded-2xl bg-white shadow p-6 flex items-center justify-between">
      <div>
        <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">Reporte de Ventas</h1>
        <p class="text-sm text-gray-500">Lectura directa de Google Sheets + métricas del mes</p>
      </div>
      <div id="statusBadge" class="text-xs px-3 py-1 rounded-full bg-gray-100">Sincronizando…</div>
    </header>

    <!-- Configuración -->
    <script>
      // URL publicada como CSV (no 'pubhtml')
      // Ejemplo: https://docs.google.com/spreadsheets/d/e/ID/pub?gid=0&single=true&output=csv
      const SALES_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTNZmwzwN0zHiYYSEpk0N11IIRouQUu85lzE6eYe4DoR1WbtnV239mtGRXPfBdbbVbSI9Scx3LVcww-/pub?gid=474194648&single=true&output=csv";
    </script>

    <!-- Filtros y KPIs -->
    <section class="grid grid-cols-1 lg:grid-cols-12 gap-4">
      <aside class="lg:col-span-3 bg-white rounded-2xl shadow p-4 space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">Mes</label>
          <select id="mesFiltro" class="w-full rounded-xl border-gray-300 focus:ring-2 focus:ring-emerald-500"></select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Buscar</label>
          <input id="buscar" type="text" placeholder="producto, cliente…" class="w-full rounded-xl border-gray-300 focus:ring-2 focus:ring-emerald-500" />
        </div>
        <div class="text-xs text-gray-500">Consejo: podés exportar esta página a PDF con Ctrl/Cmd+P.</div>
      </aside>

      <main class="lg:col-span-9 space-y-4">
        <!-- KPIs -->
        <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
          <div class="bg-white rounded-2xl shadow p-4"><div class="text-xs text-gray-500">Ventas</div><div id="kpiVentas" class="text-2xl font-bold">0</div></div>
          <div class="bg-white rounded-2xl shadow p-4"><div class="text-xs text-gray-500">Unidades</div><div id="kpiUnidades" class="text-2xl font-bold">0</div></div>
          <div class="bg-white rounded-2xl shadow p-4"><div class="text-xs text-gray-500">Ingresos</div><div id="kpiIngresos" class="text-2xl font-bold">$0</div></div>
        </div>

        <!-- Tops -->
        <div class="bg-white rounded-2xl shadow p-4">
          <h2 class="text-lg font-semibold mb-3">Highlights del mes</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="space-y-2 text-sm">
              <div><span class="font-medium">Producto más vendido: </span><span id="topProducto"></span></div>
              <div><span class="font-medium">Hamburguesa más vendida: </span><span id="topHamburguesa"></span></div>
              <div><span class="font-medium">Cerveza más vendida: </span><span id="topCerveza"></span></div>
              <div><span class="font-medium">Sándwich más vendido: </span><span id="topSandwich"></span></div>
              <div><span class="font-medium">Total cafés vendidos: </span><span id="totalCafe"></span></div>
              <div><span class="font-medium">Total hamburguesas: </span><span id="totalHamburguesas"></span></div>
            </div>
            <div class="space-y-2 text-sm">
              <div><span class="font-medium">Cervezas — detalle por tipo:</span><div id="detalleCervezas" class="mt-1"></div></div>
              <div><span class="font-medium">Día con más ventas: </span><span id="mejorDia"></span></div>
              <div><span class="font-medium">Horario pico: </span><span id="horarioPico"></span></div>
              <div><span class="font-medium">Mejor ticket: </span><span id="mejorTicket"></span></div>
            </div>
          </div>
        </div>

        <!-- Tabla -->
        <div class="bg-white rounded-2xl shadow p-4">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold">Ventas</h2>
            <button id="btnExpandir" class="text-sm px-3 py-1.5 rounded-xl bg-gray-100 hover:bg-gray-200">Expandir items</button>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-gray-50 text-gray-600">
                <tr>
                  <th class="text-left p-2">Fecha</th>
                  <th class="text-left p-2">Cliente</th>
                  <th class="text-left p-2">Mesa</th>
                  <th class="text-left p-2">Método</th>
                  <th class="text-left p-2">Items</th>
                  <th class="text-right p-2">Total</th>
                </tr>
              </thead>
              <tbody id="tbodyVentas" class="divide-y"></tbody>
            </table>
          </div>
        </div>
      </main>
    </section>
  </div>

  <script>
    // ===== Utilidades =====
    const $fmt = (n) => new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(Number(n||0));
    const monthKey = (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;

    function parseJSONSafely(s){ try{ return JSON.parse(s); }catch{ return null; } }

    // Normaliza una fila de sheet (flexible con nombres de columnas)
    function normalizeRow(row){
      // Columnas típicas de la WebApp: timestamp, cliente, mesa, metodo/metodoPago, total, items(json)
      const timestamp = row.timestamp || row.Timestamp || row.fecha || row.Fecha || '';
      const cliente = row.cliente || row.Cliente || '';
      const mesa = row.mesa || row.Mesa || '';
      const metodo = row.metodoPago || row.metodo || row.Metodo || '';
      const total = Number(row.total || row.Total || 0);
      const itemsRaw = row['items(json)'] || row.items || row.Items || row.detalle || '';
      const items = Array.isArray(itemsRaw) ? itemsRaw : (typeof itemsRaw === 'string' ? parseJSONSafely(itemsRaw) : []);
      const date = timestamp ? new Date(timestamp) : new Date();
      return { date, timestamp, cliente, mesa, metodo, total, items: items || [] };
    }

    // Clasificación simple por nombre del producto
    function classify(nombre){
      const n = (nombre||'').toLowerCase();
      const esHamb = /(hamb|burger|chees|chess|cheese|doble|triple)/.test(n);
      const esSand = /(sandwich|sándwich|tostado|lomito|bondiola|choripan|chori)/.test(n);
      const esCafe = /(cafe|café|latte|capuccino|cappuccino|espresso|expreso|americano)/.test(n);
      const esCerveza = /(ipa|stout|porter|golden|blond|blonde|scottish|honey|lager|pilsen|cerveza|beer)/.test(n);
      let tipo = 'otro';
      if(esCerveza) tipo='cerveza';
      else if(esHamb) tipo='hamburguesa';
      else if(esSand) tipo='sandwich';
      else if(esCafe) tipo='cafe';
      return tipo;
    }

    let VENTAS = []; // [{date, cliente, mesa, metodo, total, items:[{nombre,precio,costo,qty}]}]
    let VENTAS_FILTRADAS = [];
    let expandir = false;

    function cargarMeses(){
      const sel = $('#mesFiltro'); sel.empty();
      const keys = [...new Set(VENTAS.map(v => monthKey(v.date)))].sort().reverse();
      keys.forEach(k=> sel.append(`<option value="${k}">${k}</option>`));
      if(keys.length){ sel.val(keys[0]); }
    }

    function aplicarFiltros(){
      const mes = $('#mesFiltro').val();
      const q = ($('#buscar').val()||'').toLowerCase();
      VENTAS_FILTRADAS = VENTAS.filter(v => monthKey(v.date)===mes && (!q || (`${v.cliente} ${v.mesa} ${v.items.map(i=>i.nombre).join(' ')}`.toLowerCase().includes(q))));
      renderKPIs();
      renderTabla();
      renderHighlights();
    }

    function renderKPIs(){
      const ventas = VENTAS_FILTRADAS.length;
      const unidades = VENTAS_FILTRADAS.reduce((a,v)=> a + v.items.reduce((s,i)=> s + Number(i.qty||0), 0), 0);
      const ingresos = VENTAS_FILTRADAS.reduce((a,v)=> a + Number(v.total||0), 0);
      $('#kpiVentas').text(ventas);
      $('#kpiUnidades').text(unidades);
      $('#kpiIngresos').text($fmt(ingresos));
    }

    function renderTabla(){
      const tb = $('#tbodyVentas'); tb.empty();
      VENTAS_FILTRADAS.forEach(v => {
        const itemsTxt = v.items.map(i => expandir ? `${i.qty}× ${i.nombre} ($${i.precio||''})` : `${i.qty}× ${i.nombre}`).join(expandir ? '\n' : ', ');
        tb.append(`<tr>
          <td class="p-2 align-top">${v.date.toLocaleString('es-AR')}</td>
          <td class="p-2 align-top">${v.cliente||'-'}</td>
          <td class="p-2 align-top">${v.mesa||'-'}</td>
          <td class="p-2 align-top">${v.metodo||'-'}</td>
          <td class="p-2 whitespace-pre-wrap">${itemsTxt}</td>
          <td class="p-2 align-top text-right font-semibold">${$fmt(v.total)}</td>
        </tr>`);
      });
    }

    function pickTop(map){
      let topName='', topQty=0;
      for(const [name,qty] of Object.entries(map)){ if(qty>topQty){ topQty=qty; topName=name; } }
      return { name: topName || '-', qty: topQty };
    }

    function renderHighlights(){
      const porProducto = {};
      const porCerveza = {};
      let totalHamb = 0, totalCafe = 0, totalSand = 0;
      const porDia = {};  // yyyy-mm-dd -> ingresos
      const porHora = {}; // HH -> ingresos
      let mejorVenta = { total: 0, fecha: null, detalle: '' };

      VENTAS_FILTRADAS.forEach(v => {
        if(Number(v.total)>mejorVenta.total){
          mejorVenta.total=Number(v.total); mejorVenta.fecha=v.date; mejorVenta.detalle = `${v.items.length} items`;
        }
        const dia = v.date.toISOString().slice(0,10);
        const hora = String(v.date.getHours()).padStart(2,'0');
        porDia[dia] = (porDia[dia]||0) + Number(v.total||0);
        porHora[hora] = (porHora[hora]||0) + Number(v.total||0);

        v.items.forEach(i => {
          const qty = Number(i.qty||0);
          const name = (i.nombre||'').trim();
          if(!name || !qty) return;
          porProducto[name] = (porProducto[name]||0) + qty;
          const tipo = classify(name);
          if(tipo==='hamburguesa') totalHamb += qty;
          if(tipo==='cafe') totalCafe += qty;
          if(tipo==='sandwich') totalSand += qty;
          if(tipo==='cerveza') porCerveza[name] = (porCerveza[name]||0) + qty;
        });
      });

      const prodTop = pickTop(porProducto);
      const hambTop = pickTop(Object.fromEntries(Object.entries(porProducto).filter(([k])=> classify(k)==='hamburguesa')));
      const cervTop = pickTop(porCerveza);
      const sandTop = pickTop(Object.fromEntries(Object.entries(porProducto).filter(([k])=> classify(k)==='sandwich')));

      $('#topProducto').text(`${prodTop.name} (${prodTop.qty})`);
      $('#topHamburguesa').text(`${hambTop.name} (${hambTop.qty})`);
      $('#topCerveza').text(`${cervTop.name} (${cervTop.qty})`);
      $('#topSandwich').text(`${sandTop.name} (${sandTop.qty})`);
      $('#totalCafe').text(totalCafe);
      $('#totalHamburguesas').text(totalHamb);

      const cont = $('#detalleCervezas'); cont.empty();
      Object.entries(porCerveza).sort((a,b)=>b[1]-a[1])
        .forEach(([name,qty])=> cont.append(`<div class="chip mr-1 mb-1">${name}: ${qty}</div>`));

      const mejorDia = Object.entries(porDia).sort((a,b)=>b[1]-a[1])[0];
      const mejorHora = Object.entries(porHora).sort((a,b)=>b[1]-a[1])[0];
      $('#mejorDia').text(mejorDia? `${mejorDia[0]} (${$fmt(mejorDia[1])})` : '-');
      $('#horarioPico').text(mejorHora? `${mejorHora[0]}:00 (${$fmt(mejorHora[1])})` : '-');

      $('#mejorTicket').text(mejorVenta.fecha? `${mejorVenta.fecha.toLocaleString('es-AR')} — ${$fmt(mejorVenta.total)}` : '-');
    }

    function cargarVentas(){
      if(!SALES_CSV_URL || SALES_CSV_URL.startsWith('PASTE_')){
        $('#statusBadge').attr('class','text-xs px-3 py-1 rounded-full bg-red-100 text-red-700').text('Configura SALES_CSV_URL');
        return;
      }
      $('#statusBadge').attr('class','text-xs px-3 py-1 rounded-full bg-blue-100 text-blue-700').text('Cargando…');
      Papa.parse(SALES_CSV_URL, {
        download:true, header:true,
        complete: (res) => {
          VENTAS = (res.data||[])
            .filter(r => r && Object.keys(r).length)
            .map(normalizeRow)
            .filter(v => v.items && v.items.length);
          cargarMeses();
          aplicarFiltros();
          $('#statusBadge').attr('class','text-xs px-3 py-1 rounded-full bg-emerald-100 text-emerald-700').text('Listo');
        },
        error: () => {
          $('#statusBadge').attr('class','text-xs px-3 py-1 rounded-full bg-red-100 text-red-700').text('Error al cargar');
        }
      });
    }

    // ===== Eventos =====
    $(document).on('input change', '#mesFiltro, #buscar', aplicarFiltros);
    $('#btnExpandir').on('click', function(){
      expandir=!expandir; $(this).text(expandir? 'Contraer items' : 'Expandir items'); renderTabla();
    });

    // Init
    $(function(){ cargarVentas(); });
  </script>
</body>
</html>
