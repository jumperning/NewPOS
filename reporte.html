<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Reporte — OnceyDoce</title>

  <!-- Tailwind -->
  <script> window.tailwind = { config: { darkMode: 'class' } } </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --surface:#ffffff; --surface-weak:#f6f7f9;
    }
    html,body{height:100%}
    .kpi{border-radius:1rem;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.05)}
    .kpi-h{display:flex;align-items:center;justify-content:space-between}
    .kpi-title{font-size:.875rem;font-weight:600;color:#6b7280}
    .kpi-val{font-size:1.875rem;font-weight:800;letter-spacing:-.01em}
    .drag-container{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:1rem}
    .col-3{grid-column:span 3/span 3}
    .col-4{grid-column:span 4/span 4}
    .col-6{grid-column:span 6/span 6}
    .col-12{grid-column:span 12/span 12}
    @media (max-width:1024px){
      .col-3,.col-4,.col-6{grid-column:span 12/span 12}
    }
    .dragging{opacity:.5}
    .card-toggle{cursor:pointer}
    .bar{height:8px;border-radius:9999px;background:#e5e7eb;overflow:hidden}
    .bar > div{height:8px;border-radius:9999px;background:#111827;width:0%}
  </style>
</head>
<body class="bg-slate-50">

  <main class="max-w-7xl mx-auto p-4 lg:p-6">
    <h1 class="text-2xl font-bold mb-4">Reporte</h1>

    <!-- FILA KPIs -->
    <section id="kpi-row" class="drag-container mb-6">
      <!-- Ventas (mes) -->
      <article class="kpi p-5 col-3" draggable="true" data-card-id="ventas-mes">
        <div class="kpi-h">
          <div class="kpi-title">Ventas (mes)</div>
          <button class="text-gray-400 card-toggle" data-target="#ventas-mes-body">–</button>
        </div>
        <div id="ventas-mes-body" class="mt-2">
          <div id="kpi-ventas-mes" class="kpi-val">—</div>
        </div>
      </article>

      <!-- Costo del mes (COGS) -->
      <article class="kpi p-5 col-3" draggable="true" data-card-id="costo-mes">
        <div class="kpi-h">
          <div class="kpi-title">Costo del mes</div>
          <button class="text-gray-400 card-toggle" data-target="#costo-mes-body">–</button>
        </div>
        <div id="costo-mes-body" class="mt-2">
          <div id="kpi-costo-mes" class="kpi-val">—</div>
          <div class="text-xs text-gray-400">Suma de costos de todas las ventas del mes</div>
        </div>
      </article>

      <!-- Ingresos (mes) -->
      <article class="kpi p-5 col-3" draggable="true" data-card-id="ingresos-mes">
        <div class="kpi-h">
          <div class="kpi-title">Ingresos (mes)</div>
          <button class="text-gray-400 card-toggle" data-target="#ingresos-mes-body">–</button>
        </div>
        <div id="ingresos-mes-body" class="mt-2">
          <div id="kpi-ingresos-mes" class="kpi-val">—</div>
        </div>
      </article>

      <!-- Ganancia (mes) -->
      <article class="kpi p-5 col-3" draggable="true" data-card-id="ganancia-mes">
        <div class="kpi-h">
          <div class="kpi-title">Ganancia (mes)</div>
          <button class="text-gray-400 card-toggle" data-target="#ganancia-mes-body">–</button>
        </div>
        <div id="ganancia-mes-body" class="mt-2">
          <div id="kpi-ganancia-mes" class="kpi-val">—</div>
        </div>
      </article>

      <!-- GASTOS del mes (desde “Últimos gastos”) -->
      <article class="kpi p-5 col-3" draggable="true" data-card-id="gastos-mes">
        <div class="kpi-h">
          <div class="kpi-title">GASTOS del mes</div>
          <button class="text-gray-400 card-toggle" data-target="#gastos-mes-body">–</button>
        </div>
        <div id="gastos-mes-body" class="mt-2">
          <div id="kpi-gastos-mes" class="kpi-val">—</div>
          <div class="text-xs text-gray-400">Suma de “Últimos gastos” del mes</div>
        </div>
      </article>

      <!-- Costo vs. Gasto (mes) -->
      <article class="kpi p-5 col-6" draggable="true" data-card-id="costo-vs-gasto">
        <div class="kpi-h">
          <div class="kpi-title">Costo vs. Gasto (mes)</div>
          <button class="text-gray-400 card-toggle" data-target="#costo-vs-gasto-body">–</button>
        </div>
        <div id="costo-vs-gasto-body" class="mt-3">
          <div class="bar"><div id="kpi-ratio-bar"></div></div>
          <div class="mt-2 text-xs text-gray-400" id="kpi-ratio-label">—</div>
        </div>
      </article>

      <!-- Presupuesto del mes -->
      <article class="kpi p-5 col-6" draggable="true" data-card-id="presupuesto-mes">
        <div class="kpi-h">
          <div class="kpi-title">Presupuesto del mes</div>
          <button class="text-gray-400 card-toggle" data-target="#presupuesto-mes-body">–</button>
        </div>
        <div id="presupuesto-mes-body" class="mt-3">
          <div class="kpi-val" id="kpi-presu-monto">—</div>
          <div class="text-xs text-gray-400">Gasto / Presupuesto</div>
          <div class="mt-3 bar"><div id="kpi-presu-bar"></div></div>
          <div class="mt-2 text-xs text-gray-400" id="kpi-presu-label">—</div>
          <div class="mt-1 text-xs" id="kpi-presu-restante">—</div>
        </div>
      </article>
    </section>

    <!-- Sueldos & Franquero -->
    <section id="sueldos-card" class="kpi p-5 mb-6" draggable="true" data-card-id="sueldos">
      <div class="kpi-h">
        <div class="kpi-title text-base">Sueldos & Franquero</div>
        <button class="text-gray-400 card-toggle" data-target="#sueldos-body">–</button>
      </div>
      <div id="sueldos-body" class="mt-4 text-sm">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <div class="font-semibold mb-2">Sueldos (mes)</div>
            <div id="lista-sueldos" class="space-y-1"></div>
            <div class="mt-2 font-semibold">Total sueldos: <span id="total-sueldos">—</span></div>
          </div>
          <div>
            <div class="font-semibold mb-2">Separar por día (objetivo)</div>
            <div class="text-xs text-gray-500 mb-1" id="detalle-dias">—</div>
            <ul id="separar-por-dia" class="list-disc pl-5 space-y-1"></ul>
          </div>
        </div>
      </div>
    </section>

    <!-- Análisis por Categoría -->
    <section id="categorias-card" class="kpi p-5 mb-6" draggable="true" data-card-id="categorias">
      <div class="kpi-h">
        <div class="kpi-title text-base">Análisis por Categoría</div>
        <button class="text-gray-400 card-toggle" data-target="#categorias-body">–</button>
      </div>
      <div id="categorias-body" class="mt-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="kpi p-4">
            <div class="kpi-title">Participación por Unidades (%)</div>
            <div id="cat-participacion" class="mt-3 text-sm text-gray-700">—</div>
          </div>
          <div class="kpi p-4">
            <div class="kpi-title">Unidades por Categoría</div>
            <div id="cat-unidades" class="mt-3 text-sm text-gray-700">—</div>
          </div>
          <div class="kpi p-4">
            <div class="kpi-title">Ganancia por Categoría (ARS)</div>
            <div id="cat-ganancia" class="mt-3 text-sm text-gray-700">—</div>
          </div>
        </div>
        <div class="mt-4 overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50">
              <tr>
                <th class="text-left p-2">Categoría</th>
                <th class="text-right p-2">Unidades</th>
                <th class="text-right p-2">Veces</th>
                <th class="text-right p-2">Ganancia</th>
              </tr>
            </thead>
            <tbody id="cat-tabla"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Horarios con más ventas -->
    <section id="horarios-card" class="kpi p-5 mb-6" draggable="true" data-card-id="horarios">
      <div class="kpi-h">
        <div class="kpi-title text-base">Horarios con más ventas</div>
        <button class="text-gray-400 card-toggle" data-target="#horarios-body">–</button>
      </div>
      <div id="horarios-body" class="mt-4">
        <div class="kpi p-4">
          <div class="kpi-title">Ingresos por hora (mes)</div>
          <div class="mt-3 space-y-2" id="horas-bars"></div>
        </div>
      </div>
    </section>

    <!-- Gastos del local (lista del mes) -->
    <section id="gastos-card" class="kpi p-5 mb-12" draggable="true" data-card-id="gastos-lista">
      <div class="kpi-h">
        <div class="kpi-title text-base">Gastos del local (mes)</div>
        <button class="text-gray-400 card-toggle" data-target="#gastos-body">–</button>
      </div>
      <div id="gastos-body" class="mt-4">
        <div id="gastos-lista" class="text-sm text-gray-700">—</div>
      </div>
    </section>
  </main>

<script>
/* =================== Base / Adapters =================== */
const fmtARS = n => (isFinite(n) ? n : 0).toLocaleString('es-AR', {
  style:'currency', currency:'ARS', maximumFractionDigits:0
});
function rangoMes(d=new Date()){
  const y=d.getFullYear(), m=d.getMonth();
  return {from:new Date(y,m,1,0,0,0), to:new Date(y,m+1,0,23,59,59)}
}
const enRango=(d,r)=>d>=r.from && d<=r.to;

// Permite que el archivo tome datos de distintas fuentes que ya tenías:
const Data = (() => {
  const F = window.ReporteData || {};
  // ventas
  const ventas = F.ventas || window.VENTAS || window.ventas || [];
  // gastos (últimos gastos)
  const gastos = F.gastos || window.GASTOS || window.gastos || [];
  // sueldos: [{nombre, monto}]
  const sueldos = F.sueldos || window.SUELDOS || [];
  // franqueros
  const horasFranquero = Number(F.horasFranquero ?? window.HORAS_FRANQUERO ?? 0);
  const tarifaFranquero = Number(F.tarifaFranquero ?? window.TARIFA_FRANQUERO ?? 0);
  // presupuesto componentes (opcionales)
  const presupuesto = Number(F.presupuesto ?? window.PRESUPUESTO_MENSUAL ?? 0);
  const presuComponentes = F.presuComponentes || window.PRESU_COMPONENTES || null;
  return { ventas, gastos, sueldos, horasFranquero, tarifaFranquero, presupuesto, presuComponentes };
})();

/* =================== Cálculos =================== */
function costoDeVenta(v){
  if (typeof v?.costoTotal === 'number') return v.costoTotal;
  if (Array.isArray(v?.items)){
    return v.items.reduce((acc,it)=>{
      const cu=Number(it.costoUnidad ?? it.costo ?? 0);
      const q =Number(it.qty ?? it.cantidad ?? 1);
      return acc + cu*q;
    },0);
  }
  return Number(v?.costo ?? 0);
}
function ingresoDeVenta(v){
  return Number(v?.total ?? v?.monto ?? v?.ingreso ?? 0);
}
function gananciaDeVenta(v){
  const t=ingresoDeVenta(v);
  const c=costoDeVenta(v);
  return t-c;
}
function fechaDe(o){
  return new Date(o?.fecha || o?.date || o?.created_at || Date.now());
}
function categoriaDeItem(it){
  return (it.categoria || it.category || it.cat || 'Sin categoría');
}
function abrirDiasMes(openDays=[1,2,3,4,5,6]){ // lun(1) a sáb(6)
  const r=rangoMes();
  let c=0, d=new Date(r.from);
  while(d<=r.to){
    const dow=d.getDay(); // 0 dom .. 6 sáb
    const map={0:7,1:1,2:2,3:3,4:4,5:5,6:6}[dow]; // convertir a 1..7
    if (openDays.includes(map)) c++;
    d.setDate(d.getDate()+1);
  }
  return c;
}

/* =================== KPIs =================== */
function pintarKPIs(){
  const r=rangoMes();
  const ventasMes = Data.ventas.filter(v=>enRango(fechaDe(v),r));
  const gastosMes = Data.gastos.filter(g=>enRango(fechaDe(g),r));

  const ventasCount = ventasMes.length;
  const ingresosMes = ventasMes.reduce((a,v)=>a+ingresoDeVenta(v),0);
  const costoMes    = ventasMes.reduce((a,v)=>a+costoDeVenta(v),0);
  const gananciaMes = ingresosMes - costoMes;
  const gastosTotalMes = gastosMes.reduce((a,g)=>a+Number(g.monto ?? g.amount ?? g.total ?? 0),0);

  // KPIs básicos
  q('#kpi-ventas-mes').textContent   = ventasCount.toString();
  q('#kpi-ingresos-mes').textContent = fmtARS(ingresosMes);
  q('#kpi-costo-mes').textContent    = fmtARS(costoMes);
  q('#kpi-ganancia-mes').textContent = fmtARS(gananciaMes);
  q('#kpi-gastos-mes').textContent   = fmtARS(gastosTotalMes);

  // Costo vs Gasto (ratio)
  const ratio = gastosTotalMes>0 ? (costoMes/gastosTotalMes) : 0;
  const pct   = Math.min(100, Math.round((ratio||0)*100));
  const bar   = q('#kpi-ratio-bar'); if (bar){ bar.style.width=pct+'%'; bar.style.background = ratio<=0.8 ? '#16a34a' : (ratio<=1 ? '#f59e0b' : '#ef4444'); }
  const lbl   = q('#kpi-ratio-label'); if (lbl){ lbl.textContent=`${fmtARS(costoMes)} de ${fmtARS(gastosTotalMes)} (${pct}%)`; }

  // Presupuesto del mes
  let presu = 0;
  if (Data.presuComponentes){
    const {alquiler=0,servicios=0,sueldos=0,otros=0}=Data.presuComponentes;
    presu = [alquiler,servicios,sueldos,otros].map(Number).reduce((a,b)=>a+b,0);
  } else {
    presu = Number(Data.presupuesto||0);
  }
  const pbar=q('#kpi-presu-bar'), plbl=q('#kpi-presu-label'), pm=q('#kpi-presu-monto'), prest=q('#kpi-presu-restante');
  if (pm) pm.textContent = `${fmtARS(gastosTotalMes)} / ${fmtARS(presu)}`;
  const ppct = presu>0 ? Math.min(100,Math.round((gastosTotalMes/presu)*100)) : 0;
  if (pbar){ pbar.style.width=ppct+'%'; pbar.style.background = presu===0 ? '#9ca3af' : (gastosTotalMes/presu<=0.8 ? '#16a34a' : (gastosTotalMes/presu<=1 ? '#f59e0b' : '#ef4444')); }
  if (plbl) plbl.textContent = presu>0 ? `Avance: ${ppct}%` : 'Definí un presupuesto';
  if (prest) prest.textContent = presu>0 ? `Restante: ${fmtARS(Math.max(0,presu-gastosTotalMes))}` : '—';

  // Sueldos & Franquero
  const listaSueldos = q('#lista-sueldos'); listaSueldos.innerHTML='';
  const totalSueldos = (Data.sueldos||[]).reduce((a,s)=>a+Number(s.monto||0),0);
  (Data.sueldos||[]).forEach(s=>{
    const el=document.createElement('div');
    el.className='flex items-center justify-between';
    el.innerHTML=`<span>${s.nombre||'—'}</span><span class="font-semibold">${fmtARS(Number(s.monto||0))}</span>`;
    listaSueldos.appendChild(el);
  });
  q('#total-sueldos').textContent = fmtARS(totalSueldos);
  const diasAbiertos = abrirDiasMes([1,2,3,4,5,6]); // lun-sab
  q('#detalle-dias').textContent = `Objetivo distribuido en ${diasAbiertos} días abiertos (lun a sáb)`;
  const ul=q('#separar-por-dia'); ul.innerHTML='';
  if (diasAbiertos>0){
    const porDiaTotal = totalSueldos/diasAbiertos;
    ul.insertAdjacentHTML('beforeend', `<li>Total por día: <strong>${fmtARS(porDiaTotal)}</strong></li>`);
    (Data.sueldos||[]).forEach(s=>{
      ul.insertAdjacentHTML('beforeend', `<li>${s.nombre||'—'}: ${fmtARS((Number(s.monto||0))/diasAbiertos)}</li>`);
    });
    // Franquero adicional
    const totalFranquero = (Data.horasFranquero||0)*(Data.tarifaFranquero||0);
    if (totalFranquero>0){
      ul.insertAdjacentHTML('beforeend', `<li>Franquero (total): ${fmtARS(totalFranquero)} — por día: ${fmtARS(totalFranquero/diasAbiertos)}</li>`);
    }
  } else {
    ul.textContent='—';
  }

  // Análisis por Categoría (a partir de items de ventas)
  const catMap = new Map(); // {cat: {unidades, veces, ganancia}}
  ventasMes.forEach(v=>{
    const items = Array.isArray(v.items)? v.items : [];
    const ingreso = ingresoDeVenta(v);
    items.forEach(it=>{
      const cat = categoriaDeItem(it);
      const q   = Number(it.qty ?? it.cantidad ?? 1);
      const p   = Number(it.precio ?? it.price ?? 0);
      const c   = Number(it.costoUnidad ?? it.costo ?? 0);
      const g   = (p-c)*q;
      if(!catMap.has(cat)) catMap.set(cat,{unidades:0,veces:0,ganancia:0});
      const o=catMap.get(cat);
      o.unidades += q;
      o.veces    += 1;
      o.ganancia += isFinite(g)?g:0;
      catMap.set(cat,o);
    });
  });
  const totalUnidades = Array.from(catMap.values()).reduce((a,o)=>a+o.unidades,0) || 1;
  // Topes visuales simples (texto con barras)
  const part = q('#cat-participacion'), uni=q('#cat-unidades'), gan=q('#cat-ganancia'), tbody=q('#cat-tabla');
  function barTxt(val,pct){
    return `<div class="flex items-center gap-2"><div class="bar w-full"><div style="width:${pct}%"></div></div><span class="text-xs w-16 text-right">${pct}%</span></div>`;
  }
  if (catMap.size){
    const parts=[], unis=[], gans=[], rows=[];
    const maxU = Math.max(...Array.from(catMap.values()).map(o=>o.unidades));
    const maxG = Math.max(...Array.from(catMap.values()).map(o=>o.ganancia));
    catMap.forEach((o,cat)=>{
      const pct = Math.round((o.unidades/totalUnidades)*100);
      parts.push(`<div class="mb-1"><div class="flex justify-between"><span>${cat}</span><span>${pct}%</span></div><div class="bar"><div style="width:${pct}%; background:#0ea5e9"></div></div></div>`);
      const upct = Math.round((o.unidades/maxU)*100);
      unis.push(`<div class="mb-1"><div class="flex justify-between"><span>${cat}</span><span>${o.unidades}</span></div><div class="bar"><div style="width:${upct}%; background:#10b981"></div></div></div>`);
      const gpct = maxG>0 ? Math.round((o.ganancia/maxG)*100) : 0;
      gans.push(`<div class="mb-1"><div class="flex justify-between"><span>${cat}</span><span>${fmtARS(o.ganancia)}</span></div><div class="bar"><div style="width:${gpct}%; background:#f97316"></div></div></div>`);
      rows.push(`<tr class="border-t">
        <td class="p-2">${cat}</td>
        <td class="p-2 text-right">${o.unidades}</td>
        <td class="p-2 text-right">${o.veces}</td>
        <td class="p-2 text-right">${fmtARS(o.ganancia)}</td>
      </tr>`);
    });
    part.innerHTML = parts.join('');
    uni.innerHTML  = unis.join('');
    gan.innerHTML  = gans.join('');
    tbody.innerHTML= rows.join('');
  } else {
    part.textContent='—'; uni.textContent='—'; gan.textContent='—'; tbody.innerHTML='';
  }

  // Horarios con más ventas (ingresos por hora)
  const horas = Array.from({length:24},(_,h)=>({h,ing:0}));
  ventasMes.forEach(v=>{
    const d=fechaDe(v); const h=d.getHours();
    horas[h].ing += ingresoDeVenta(v);
  });
  const maxIng = Math.max(...horas.map(x=>x.ing)) || 1;
  const horasBars = q('#horas-bars'); horasBars.innerHTML='';
  horas.forEach(({h,ing})=>{
    const pct = Math.round((ing/maxIng)*100);
    const row = document.createElement('div');
    row.innerHTML = `
      <div class="flex items-center gap-3">
        <div class="w-16 text-xs text-gray-500">${String(h).padStart(2,'0')}:00</div>
        <div class="bar w-full"><div style="width:${pct}%; background:#6366f1"></div></div>
        <div class="w-24 text-right text-xs">${fmtARS(ing)}</div>
      </div>`;
    horasBars.appendChild(row);
  });

  // Gastos del local — lista del mes
  const gl = q('#gastos-lista');
  if (gastosMes.length){
    gl.innerHTML = `<ul class="list-disc pl-5 space-y-1">
      ${gastosMes.map(g=>`<li><span class="text-gray-500 text-xs">${fechaDe(g).toLocaleDateString('es-AR')}</span> — ${g.descripcion||g.detalle||g.categoria||'Gasto'}: <strong>${fmtARS(Number(g.monto ?? g.amount ?? g.total ?? 0))}</strong></li>`).join('')}
    </ul>`;
  } else {
    gl.textContent='—';
  }
}

/* =================== Drag & Minimize (persisten) =================== */
function q(sel){return document.querySelector(sel)}
function $all(sel){return Array.from(document.querySelectorAll(sel))}
function loadLayout(){
  const saved = JSON.parse(localStorage.getItem('report-layout')||'[]');
  const conts = document.querySelectorAll('[data-card-id]');
  const map = {}; conts.forEach(el=>map[el.dataset.cardId]=el);
  const parent = conts[0]?.parentElement;
  if (saved.length && parent){
    saved.forEach(id=>{ if(map[id]) parent.appendChild(map[id]); });
  }
}
function saveLayout(){
  const ids = $all('[data-card-id]').map(el=>el.dataset.cardId);
  localStorage.setItem('report-layout', JSON.stringify(ids));
}
function enableDrag(){
  $all('[data-card-id]').forEach(el=>{
    el.addEventListener('dragstart', e=>{ el.classList.add('dragging'); e.dataTransfer.setData('text/plain', el.dataset.cardId); });
    el.addEventListener('dragend',   e=>{ el.classList.remove('dragging'); saveLayout(); });
  });
  // Delegado a nivel main
  const main = document.querySelector('main');
  main.addEventListener('dragover', e=>{
    const dragging = document.querySelector('.dragging');
    if(!dragging) return;
    e.preventDefault();
    const cards = $all('[data-card-id]:not(.dragging)');
    // Insertar antes del primer card cuya posición vertical sea mayor
    const y = e.clientY;
    let target = null;
    for (const c of cards){ const r=c.getBoundingClientRect(); if (y < r.top + r.height/2){ target=c; break; } }
    if (target) target.parentElement.insertBefore(dragging, target);
    else dragging.parentElement.appendChild(dragging);
  });
}
function enableMinimize(){
  $all('.card-toggle').forEach(btn=>{
    const sel = btn.getAttribute('data-target');
    const body = document.querySelector(sel);
    const key  = 'collapse:'+sel;
    // load
    const collapsed = localStorage.getItem(key)==='1';
    if (collapsed && body){ body.style.display='none'; btn.textContent='+'; }
    btn.addEventListener('click', ()=>{
      if (!body) return;
      const isHidden = body.style.display==='none';
      body.style.display = isHidden ? '' : 'none';
      btn.textContent = isHidden ? '–' : '+';
      localStorage.setItem(key, isHidden ? '0' : '1');
    });
  });
}

/* =================== Init =================== */
document.addEventListener('DOMContentLoaded', ()=>{
  loadLayout();
  enableDrag();
  enableMinimize();
  pintarKPIs();
});
</script>
</body>
</html>
