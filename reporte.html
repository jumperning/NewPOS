<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reporte de Ventas ‚Äî OnceyDoce</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    .chip{display:inline-flex;align-items:center;padding:.125rem .5rem;border-radius:9999px;font-size:.75rem;line-height:1rem;background:#f3f4f6;color:#374151}
    .btn{padding:.375rem .75rem;border-radius:.75rem;background:#f3f4f6}
    .btn:hover{background:#e5e7eb}
    /* üëÅÔ∏è estilos para ocultar montos */
.hide-money .money {
  color: transparent !important;
  text-shadow: 0 0 8px #999;
}
  </style>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="max-w-7xl mx-auto p-4 sm:p-6 space-y-6">
   <header class="rounded-2xl bg-white shadow p-6 flex items-center justify-between">
  <h1 class="text-2xl sm:text-3xl font-extrabold">Reporte de Ventas</h1>
  <div class="flex items-center gap-3">
    <!-- üëÅÔ∏è Bot√≥n mostrar/ocultar montos -->
    <button id="btnToggleMoneda" class="text-gray-500 hover:text-gray-700" title="Mostrar/ocultar montos">
      üëÅÔ∏è
    </button>
    <div id="statusBadge" class="text-xs px-3 py-1 rounded-full bg-gray-100">Sincronizando‚Ä¶</div>
  </div>
</header>

    <!-- Config -->
    <section class="rounded-2xl bg-white shadow p-4">
      <label class="block text-sm font-medium mb-1">URL CSV publicada (hoja POSOnceyDoce)</label>
      <input id="csvUrl" type="text" class="w-full rounded-xl border-gray-300"
        value="https://docs.google.com/spreadsheets/d/e/2PACX-1vTNZmwzwN0zHiYYSEpk0N11IIRouQUu85lzE6eYe4DoR1WbtnV239mtGRXPfBdbbVbSI9Scx3LVcww-/pub?gid=474194648&single=true&output=csv" />
      <div id="diag" class="text-xs text-gray-500 mt-2"></div>
      <button id="btnReload" class="mt-3 px-3 py-1.5 rounded-xl bg-gray-100 hover:bg-gray-200 text-sm">Recargar</button>
    </section>

    <section class="grid grid-cols-1 lg:grid-cols-12 gap-4">
      <!-- Filtros -->
      <aside class="lg:col-span-3 bg-white rounded-2xl shadow p-4 space-y-4">
        <!-- Encabezado + bot√≥n de personalizaci√≥n -->
        <div class="flex items-center justify-between">
          <h3 class="text-sm font-semibold">Filtros</h3>
          <button id="btnConfigFiltros" class="btn text-xs">Personalizar filtros</button>
        </div>

        <!-- Mes -->
        <div id="filtMes">
          <label class="block text-sm font-medium mb-1">Mes</label>
          <select id="mesFiltro" class="w-full rounded-xl border-gray-300"></select>
        </div>

        <!-- D√≠a -->
        <div id="filtDia">
          <label class="block text-sm font-medium mb-1">D√≠a</label>
          <input id="diaFiltro" type="date" class="w-full rounded-xl border-gray-300" />
          <div class="flex gap-2 mt-2">
            <button type="button" class="btn" id="btnHoy">Hoy</button>
            <button type="button" class="btn" id="btnAyer">Ayer</button>
            <button type="button" class="btn" id="btnMenos2">-2 d√≠as</button>
          </div>
          <p class="text-xs text-gray-500 mt-2">Afecta los KPIs diarios (Ganancia/Ingresos/Unidades/Ventas/Costo).</p>
        </div>

        <!-- Filtro por horario -->
        <div id="filtHorario">
          <label class="block text-sm font-medium mb-1">Filtrar por horario (del d√≠a seleccionado)</label>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <span class="text-xs text-gray-600">Desde</span>
              <input id="horaDesde" type="time" class="w-full rounded-xl border-gray-300" />
            </div>
            <div>
              <span class="text-xs text-gray-600">Hasta</span>
              <input id="horaHasta" type="time" class="w-full rounded-xl border-gray-300" />
            </div>
          </div>
          <p class="text-xs text-gray-500 mt-2">Se aplica a KPIs del d√≠a y, si el alcance es ‚ÄúD√≠a‚Äù, tambi√©n al an√°lisis.</p>
        </div>

        <!-- Buscar -->
        <div id="filtBuscar">
          <label class="block text-sm font-medium mb-1">Buscar</label>
          <input id="buscar" type="text" placeholder="producto, cliente‚Ä¶" class="w-full rounded-xl border-gray-300" />
        </div>

        <!-- Categor√≠a -->
        <div id="filtCategoria">
          <label class="block text-sm font-medium mb-1">Filtrar por Categor√≠a</label>
          <select id="catFiltro" class="w-full rounded-xl border-gray-300">
            <option value="">Todas</option>
            <option value="Caf√©">Caf√©</option>
            <option value="Comida">Comida</option>
            <option value="Cerveza">Cerveza</option>
            <option value="Gaseosa">Gaseosa</option>
            <option value="Agua">Agua</option>
            <option value="Vino">Vino</option>
            <option value="Whisky">Whisky</option>
            <option value="Tragos">Tragos</option>
          </select>
          <p class="text-xs text-gray-500 mt-2">Por ejemplo: solo ‚ÄúVino‚Äù, ‚ÄúWhisky‚Äù o ‚ÄúTragos‚Äù.</p>
        </div>
      </aside>

      <main class="lg:col-span-9 space-y-4">
        <!-- KPIs Mensuales -->
        <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
          <div class="bg-white rounded-2xl shadow p-4"><div class="text-xs text-gray-500">Ventas (mes)</div><div id="kpiVentas" class="text-2xl font-bold money">0</div></div>
          <div class="bg-white rounded-2xl shadow p-4"><div class="text-xs text-gray-500">Unidades (mes)</div><div id="kpiUnidades" class="text-2xl font-bold money">0</div></div>
          <div class="bg-white rounded-2xl shadow p-4"><div class="text-xs text-gray-500">Ingresos (mes)</div><div id="kpiIngresos" class="text-2xl font-bold money">$0</div></div>
        </div>

        <!-- KPIs del D√≠a -->
        <div class="grid grid-cols-2 sm:grid-cols-5 gap-4">
          <div class="bg-white rounded-2xl shadow p-4"><div class="text-xs text-gray-500">Ganancia (d√≠a)</div><div id="kpiGanDia" class="text-2xl font-bold money">$0</div><div id="kpiGanDiaLbl" class="text-xs text-gray-500 mt-1"></div></div>
          <div class="bg-white rounded-2xl shadow p-4"><div class="text-xs text-gray-500">Ingresos (d√≠a)</div><div id="kpiIngDia" class="text-2xl font-bold money">$0</div></div>
          <div class="bg-white rounded-2xl shadow p-4"><div class="text-xs text-gray-500">Unidades (d√≠a)</div><div id="kpiUniDia" class="text-2xl font-bold money">0</div></div>
          <div class="bg-white rounded-2xl shadow p-4"><div class="text-xs text-gray-500">Ventas (d√≠a)</div><div id="kpiVentasDia" class="text-2xl font-bold money">0</div></div>
          <div class="bg-white rounded-2xl shadow p-4"><div class="text-xs text-gray-500">Costo (d√≠a)</div><div id="kpiCostoDia" class="text-2xl font-bold money">$0</div></div>
        </div>

        <!-- An√°lisis por Categor√≠a -->
        <div class="bg-white rounded-2xl shadow p-4 space-y-4">
          <div class="flex flex-wrap items-center gap-3">
            <h2 class="text-lg font-semibold mr-auto">An√°lisis por Categor√≠a</h2>
            <div class="flex gap-2">
              <span class="chip cursor-default">Caf√©</span>
              <span class="chip cursor-default">Comida</span>
              <span class="chip cursor-default">Cerveza</span>
              <span class="chip cursor-default">Gaseosa</span>
              <span class="chip cursor-default">Agua</span>
              <span class="chip cursor-default">Vino</span>
              <span class="chip cursor-default">Whisky</span>
              <span class="chip cursor-default">Tragos</span>
            </div>
          </div>

          <!-- Alcance -->
          <div class="flex flex-wrap gap-3 items-end">
            <div>
              <label class="block text-xs text-gray-600 mb-1">Alcance</label>
              <select id="alcanceSel" class="rounded-xl border-gray-300">
                <option value="mes">Mes completo (seleccionado)</option>
                <option value="dia">D√≠a (usa el selector de la izquierda)</option>
                <option value="rango">Rango de fechas</option>
              </select>
            </div>
            <div id="rangoWrap" class="hidden flex items-end gap-2">
              <div><label class="block text-xs text-gray-600 mb-1">Desde</label><input id="desdeFecha" type="date" class="rounded-xl border-gray-300"></div>
              <div><label class="block text-xs text-gray-600 mb-1">Hasta</label><input id="hastaFecha" type="date" class="rounded-xl border-gray-300"></div>
              <button id="btnAplicarRango" class="btn">Aplicar</button>
            </div>
            <label class="inline-flex items-center gap-2 ml-auto">
              <input id="chkDiaDia" type="checkbox" class="rounded">
              <span class="text-sm text-gray-700">D√≠a a d√≠a (serie)</span>
            </label>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="aggWrap">
            <div class="rounded-xl border p-3"><div class="text-sm text-gray-500 mb-2">Participaci√≥n por Unidades (%)</div><canvas id="chartPie"></canvas></div>
            <div class="rounded-xl border p-3"><div class="text-sm text-gray-500 mb-2">Unidades por Categor√≠a</div><canvas id="chartBarQty"></canvas></div>
            <div class="rounded-xl border p-3"><div class="text-sm text-gray-500 mb-2">Ganancia por Categor√≠a (ARS)</div><canvas id="chartBarProfit"></canvas></div>
          </div>

          <div id="dailyWrap" class="rounded-xl border p-3 hidden">
            <div class="text-sm text-gray-500 mb-2">Unidades ‚Äî D√≠a a d√≠a (apilado por categor√≠a)</div>
            <canvas id="chartDailyQty"></canvas>
          </div>

          <div class="overflow-x-auto">
            <table class="w-full text-sm mt-2">
              <thead class="bg-gray-50 text-gray-600">
                <tr>
                  <th class="text-left p-2">Categor√≠a</th>
                  <th class="text-right p-2">Unidades</th>
                  <th class="text-right p-2">Veces</th>
                  <th class="text-right p-2">Ganancia</th>
                </tr>
              </thead>
              <tbody id="tbodyResumenCat" class="divide-y"></tbody>
            </table>
          </div>
        </div>

        <!-- Top & Explorador de √≠tems -->
        <div class="bg-white rounded-2xl shadow p-4 space-y-4">
          <div class="flex flex-wrap gap-3 items-end">
            <h2 class="text-lg font-semibold mr-auto">Top & Explorador de √çtems</h2>
            <div>
              <label class="block text-xs text-gray-600 mb-1">Categor√≠a (opcional)</label>
              <select id="itemCatSel" class="rounded-xl border-gray-300">
                <option value="">Todas</option>
                <option>Caf√©</option><option>Comida</option><option>Cerveza</option>
                <option>Gaseosa</option><option>Agua</option><option>Vino</option>
                <option>Whisky</option><option>Tragos</option>
              </select>
            </div>
            <div>
              <label class="block text-xs text-gray-600 mb-1">Filtrar por texto</label>
              <input id="itemTextSel" type="text" placeholder="ej: hamburguesa, empanada, ipa‚Ä¶" class="rounded-xl border-gray-300"/>
            </div>
            <div>
              <label class="block text-xs text-gray-600 mb-1">Ordenar por</label>
              <select id="itemSortSel" class="rounded-xl border-gray-300">
                <option value="qty">Unidades</option>
                <option value="ingreso">Ingresos</option>
                <option value="veces">Veces</option>
                <option value="ganancia">Ganancia</option>
              </select>
            </div>
            <div>
              <label class="block text-xs text-gray-600 mb-1">Top N</label>
              <input id="itemTopN" type="number" min="3" value="10" class="w-20 rounded-xl border-gray-300"/>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="rounded-xl border p-3">
              <div class="text-sm text-gray-500 mb-2">Top por Unidades (seg√∫n alcance)</div>
              <canvas id="chartTopItems"></canvas>
            </div>
            <div class="overflow-x-auto rounded-xl border">
              <table class="w-full text-sm">
                <thead class="bg-gray-50 text-gray-600">
                  <tr>
                    <th class="text-left p-2">√çtem</th>
                    <th class="text-right p-2">Unid.</th>
                    <th class="text-right p-2">Veces</th>
                    <th class="text-right p-2">Ingreso</th>
                    <th class="text-right p-2">Ganancia</th>
                    <th class="text-left p-2">Categor√≠a</th>
                  </tr>
                </thead>
                <tbody id="tbodyItems" class="divide-y"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Horarios -->
        <div class="bg-white rounded-2xl shadow p-4 space-y-2">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold">Horarios con m√°s ventas</h2>
            <div class="text-xs text-gray-500" id="lblPeakHour"></div>
          </div>
          <div class="rounded-xl border p-3">
            <div class="text-sm text-gray-500 mb-2">Ingresos por hora (seg√∫n alcance)</div>
            <canvas id="chartHoras"></canvas>
          </div>
        </div>

        <!-- Cierre y reparto -->
        <div class="border-t pt-4">
          <h3 class="text-sm font-semibold mb-2">Cierre y reparto</h3>
          <div class="grid grid-cols-2 gap-2">
            <div><label class="block text-xs text-gray-600 mb-1">Personas</label><input id="cierrePersonas" type="number" min="1" value="4" class="w-full rounded-xl border-gray-300" /></div>
            <div><label class="block text-xs text-gray-600 mb-1">Gastos del d√≠a (ARS)</label><input id="cierreGastos" type="number" step="1" value="0" class="w-full rounded-xl border-gray-300" /></div>
          </div>
          <p class="text-xs text-gray-500 mt-2">Usa el d√≠a y horario seleccionados arriba.</p>
        </div>

        <div class="bg-white rounded-2xl shadow p-4">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold">Cierre y reparto</h2>
            <span class="text-xs text-gray-500" id="cierreRangoLbl"></span>
          </div>

          <div class="grid grid-cols-2 sm:grid-cols-6 gap-4">
            <div class="rounded-xl border p-3"><div class="text-xs text-gray-500">Ingresos (d√≠a)</div><div id="cierreIng" class="text-xl font-bold money">$0</div></div>
            <div class="rounded-xl border p-3"><div class="text-xs text-gray-500">Costo (d√≠a)</div><div id="cierreCosto" class="text-xl font-bold money">$0</div></div>
            <div class="rounded-xl border p-3"><div class="text-xs text-gray-500">Ganancia bruta</div><div id="cierreBruta" class="text-xl font-bold money">$0</div></div>
            <div class="rounded-xl border p-3"><div class="text-xs text-gray-500">Gastos del local</div><div id="cierreGastosLbl" class="text-xl font-bold money">$0</div></div>
            <div class="rounded-xl border p-3"><div class="text-xs text-gray-500">Ganancia neta</div><div id="cierreNeta" class="text-xl font-bold money">$0</div></div>
            <div class="rounded-xl border p-3"><div class="text-xs text-gray-500">Por persona</div><div id="cierrePorPersona" class="text-xl font-bold money">$0</div></div>
          </div>
        </div>

        <!-- Tabla -->
        <div class="bg-white rounded-2xl shadow p-4">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold">Ventas</h2>
            <div class="flex gap-2">
              <button id="btnExcel" class="text-sm px-3 py-1.5 rounded-xl bg-gray-100 hover:bg-gray-200">Descargar Excel</button>
              <button id="btnExcelFact" class="text-sm px-3 py-1.5 rounded-xl bg-gray-100 hover:bg-gray-200">Exportar Facturaci√≥n</button>
              <button id="btnExpandir" class="text-sm px-3 py-1.5 rounded-xl bg-gray-100 hover:bg-gray-200">Expandir items</button>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-gray-50 text-gray-600">
                <tr>
                  <th class="text-left p-2">Fecha</th>
                  <th class="text-left p-2">Cliente</th>
                  <th class="text-left p-2">Mesa</th>
                  <th class="text-left p-2">M√©todo</th>
                  <th class="text-left p-2">Items</th>
                  <th class="text-right p-2">Total</th>
                  <th class="text-right p-2">Ganancia</th>
                </tr>
              </thead>
              <tbody id="tbodyVentas" class="divide-y"></tbody>
            </table>
          </div>
          <!-- Paginador -->
          <div id="paginador" class="flex flex-wrap items-center gap-2 justify-between mt-3 text-sm"></div>
        </div>
      </main>
    </section>
  </div>

  <!-- Panel flotante para elegir qu√© filtros se ven -->
  <div id="panelFiltros" class="hidden fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/30"></div>
    <div class="relative bg-white rounded-2xl shadow-xl p-4 w-[min(92vw,420px)]">
      <h4 class="font-semibold mb-3">Mostrar filtros</h4>
      <div class="space-y-2 text-sm">
        <label class="flex items-center gap-2"><input type="checkbox" class="chkFilt" value="filtMes"> Mes</label>
        <label class="flex items-center gap-2"><input type="checkbox" class="chkFilt" value="filtDia"> D√≠a</label>
        <label class="flex items-center gap-2"><input type="checkbox" class="chkFilt" value="filtHorario"> Horario</label>
        <label class="flex items-center gap-2"><input type="checkbox" class="chkFilt" value="filtBuscar"> Buscar</label>
        <label class="flex items-center gap-2"><input type="checkbox" class="chkFilt" value="filtCategoria"> Categor√≠a</label>
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button id="btnFiltCancelar" class="btn">Cancelar</button>
        <button id="btnFiltGuardar" class="btn">Guardar</button>
      </div>
    </div>
  </div>
    <script src="report.js"></script>
</body>
</html>
